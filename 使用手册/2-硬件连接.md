# 硬件连接

<div align="center">

![硬件连接](https://via.placeholder.com/600x150/4CAF50/FFFFFF?text=%E7%A1%AC%E4%BB%B6%E8%BF%9E%E6%8E%A5)

</div>

## 📑 目录

- [硬件连接](#硬件连接)
  - [STM32F103引脚定义](#stm32f103引脚定义)
  - [CAN收发器接线图](#can收发器接线图)
  - [硬件电路注意事项](#硬件电路注意事项)
  - [终端电阻说明](#终端电阻说明)

---

## STM32F103引脚定义

STM32F103C8T6的CAN通信使用内置的CAN控制器，需要外接CAN收发器芯片才能与CAN总线通信。

<div style="background-color:#e8f4ff;padding:15px;border-radius:5px;margin:10px 0;">

**CAN通信引脚定义**：
- **PA11 (RX)**: CAN接收引脚，连接到CAN收发器的TX输出
- **PA12 (TX)**: CAN发送引脚，连接到CAN收发器的RX输入

⚠️ **注意**：在STM32F103C8T6芯片中，CAN引脚（PA11/PA12）与USB引脚共用，因此**不能同时使用USB和CAN功能**。

</div>

引脚图示：

```
        ┌─────────┐
        │         │
        │         │                STM32F103C8T6
        │         │                 引脚排列
        │         │
   PA11 │[11]     │     
   PA12 │[12]     │
        │         │
        │         │
        └─────────┘
```

## CAN收发器接线图

CAN总线需要使用专用的CAN收发器芯片将单片机的逻辑电平转换为CAN总线的差分信号。最常用的收发器芯片包括TJA1050、MCP2551和SN65HVD230等。

<details>
<summary>💻 使用TJA1050收发器的典型连接方式</summary>

**TJA1050引脚定义**:
1. TXD: 发送数据输入（连接到STM32的TX引脚）
2. GND: 接地
3. VCC: 电源输入（5V）
4. RXD: 接收数据输出（连接到STM32的RX引脚）
5. VREF: 参考电压输出
6. CANL: CAN_L总线线路
7. CANH: CAN_H总线线路
8. S: 静默模式控制（通常接高电平或通过单片机IO控制）

</details>

### 标准连接图

以下是STM32F103C8T6连接TJA1050收发器的标准接线图：

```
+---------------+                +---------------+                 +-----------+
|               |                |               |                 |           |
|  STM32F103    |                |    TJA1050    |                 | CAN总线   |
|               |                |               |                 |           |
|           PA12|--------------->|TXD         CANH|---------------->|CANH      |
|               |                |               |                 |           |
|           PA11|<---------------|RXD         CANL|---------------->|CANL      |
|               |                |               |                 |           |
|            5V |--------------->|VCC          GND|                 |           |
|               |                |               |                 |           |
|           GND |--------------->|GND            |                 |           |
|               |                |               |                 |           |
|           3.3V|--------------->|S              |                 |           |
|               |                |               |                 |           |
+---------------+                +---------------+                 +-----------+
```

### 实际连接示例

以下是一个使用杜邦线连接STM32F103C8T6开发板与CAN收发器模块的实际示例：

<div style="background-color:#f5f5f5;padding:15px;border-radius:5px;margin:10px 0;">

**开发板到TJA1050模块连接**:
- STM32的PA11 → TJA1050的RXD
- STM32的PA12 → TJA1050的TXD
- STM32的5V → TJA1050的VCC
- STM32的GND → TJA1050的GND
- STM32的3.3V或5V → TJA1050的S（使能引脚，若模块有上拉电阻可不接）

</div>

## 硬件电路注意事项

在连接STM32与CAN收发器时，需要注意以下几点：

<details>
<summary>⚠️ 电源要求</summary>

1. **电平匹配**:
   - STM32F103工作在3.3V逻辑电平
   - TJA1050等收发器的数字端可以兼容3.3V逻辑电平
   - 收发器通常需要5V电源供电

2. **电源稳定性**:
   - 为收发器提供稳定的5V电源
   - 使用去耦电容（如0.1μF并联10μF）连接在收发器的VCC和GND之间
   - 在高速通信时，良好的电源去耦更为重要

</details>

<details>
<summary>💡 信号完整性</summary>

1. **连线长度**:
   - STM32到收发器的连线应尽量短
   - 避免长杜邦线引起的干扰

2. **屏蔽措施**:
   - 在干扰环境强的场合，考虑为CAN_H和CAN_L使用双绞线
   - 双绞线屏蔽层应单点接地

3. **防护电路**:
   - 某些工业环境可能需要增加ESD保护和共模抑制

</details>

## 终端电阻说明

CAN总线为了避免信号反射，需要在总线两端各接一个120Ω的终端电阻。

### 终端电阻的作用

<div style="background-color:#fff8e1;padding:15px;border-radius:5px;border-left:5px solid #ffa000;margin:10px 0;">

终端电阻的主要作用是:
- 匹配CAN总线特性阻抗(约120Ω)
- 防止信号在总线末端反射
- 确保信号完整性，特别是在高速通信和长线缆场景

如果没有正确安装终端电阻，可能导致:
- 通信错误率增高
- 传输距离受限
- 在高速率下完全无法通信

</div>

### 终端电阻连接方式

CAN总线终端电阻的标准连接方式如下图所示：

```
节点1                  节点2                  节点N
 +---+                  +---+                  +---+
 |   |                  |   |                  |   |
 | S |                  | S |                  | S |
 | T |                  | T |                  | T |
 | M |                  | M |                  | M |
 |   |                  |   |                  |   |
 +---+                  +---+                  +---+
   |                      |                      |
   |                      |                      |
   |                      |                      |
   |                      |                      |
   |                      |                      |
---+----------------------+----------------------+---
   |                      |                      |
 CANH                   CANH                   CANH
   |                      |                      |
   |                      |                      |
   |                      |                      |
CAN总线                                          |
   |                      |                      |
   |                      |                      |
   |                      |                      |
 CANL                   CANL                   CANL
   |                      |                      |
---+----------------------+----------------------+---
   |                                             |
   |                                             |
   |                                             |
  +++                                           +++
  | |                                           | |
  |R|  120Ω                                     |R|  120Ω
  | |                                           | |
  +++                                           +++
   |                                             |
   |                                             |
   +---------------------------------------------+
```

### 终端电阻测试方法

要验证终端电阻是否正确安装，可以使用万用表测量：

<div style="background-color:#f0f0f0;padding:15px;border-radius:5px;margin:10px 0;">

**测试步骤**:
1. 断开CAN总线上所有设备的电源
2. 使用万用表欧姆档测量CANH和CANL之间的电阻
3. 如果总线上正确安装了两个120Ω终端电阻，则测得的总电阻应约为60Ω（两个120Ω并联）

</div>

### 实际应用注意事项

在STM32 CAN通信的实际应用中，关于终端电阻需要注意：

1. **短距离测试**：在实验室短距离测试（<1m）时，即使没有终端电阻通常也能正常通信，但这不是标准做法

2. **集成终端电阻**：许多CAN收发器模块已经集成了120Ω终端电阻，可通过跳线或开关使能

3. **总线拓扑**：CAN总线要求线型拓扑，各节点通过短支线连接到主干线

4. **波特率与距离**：终端电阻对高波特率和长距离的影响更明显
   - 1Mbps: 必须有正确的终端电阻
   - 低速场景: 对终端电阻要求较低

---

硬件连接是CAN通信的基础，正确的连接方式能够确保通信的可靠性。接下来，我们将了解如何配置STM32F103C8T6的CAN外设。 