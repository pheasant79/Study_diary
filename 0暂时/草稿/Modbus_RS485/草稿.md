发言人  
这节课我们来介绍一下基于RS485的model bus通信协议。谈到通信的话，我们不得不从两个方面来具体的分析。一方面就是硬件层，另外一方面就是软件层。我们来给大家具体的来分析一下。那就是说我们一般讲的通信，它有两个标准或者是两个协议。一般来说可以分成这么两个部分，一个叫做硬件层的那比如说我们这节课要介绍的RS485。这个就是一个硬件层的一个通信的一个标准。
发言人  
那它主要解决的什么问题呢？它主要解决的是我们数据的一个传输问题。也就是说我们如何将一个数。我们在计算机当中的数当然就指的是零或是1，对吧？就是零或者是1，也就是零或者是1。如何传输到另外一端？
发言人  
也就是说我们如何将0和1从1个设备传输到另外一个设备，对吧？我们就直接另外一端。这个就是我们硬件层要解决的问题。当然了，它会规定了一些比如说它的一个电器标准，或者说它的一个接口标准等等这些东西。包括它的传输线等等的，有些标准协议当中是把它规定好了，有些就是说只规定了一些电器的标准。这个大家可以去具体的了解一下。我们比如说硬件层的一些通信标准，比如说有RS485，还有就比如说是2232，这种都属于是硬件层的一个传输的一个标准。
发言人  
还有一方面就是软件协议，就是软件层。软件层它比如说我们这节课要介绍的model bus。软件层的通信协议，它是在硬件的一个基础上，对吧？那比如说我们的mode bus，我可以讲是基于RS485的model bus通讯协议。那我也可以基于RS232对吧？那我也可以基于其他的一些硬件的一个层的一个传输协议，来定义这个软件层的一个标准。所以大家一定要区分硬件层和软件层。硬件层解决是如何把零和1传输到另外一端？
发言人  
软件层是解决了什么问题呢？软件层比如说我们这个mod bus通讯协议，它是解决的是。数据传输的一个含义。或者意义对吧？也就是说你传的这个数代表的是什么含义或者什么意义，要解决什么问题？这个是软件层协议的一个规定。那也就相当于是我们硬件层相当于是一个公路，对吧？就说先修了一条路，保证了我们的数或者说我们的车能够从这个城市转移到另外一个城市。
发言人  
我们的软件层，它解决的就是说像交通规则一样。它要保证的是如何传输，或者说是你传输的所代表的一个含义，就解决一些规则的问题。这个就是软件层一个协议。
发言人  
大家一定要注意，model bus是一个软件层的协议，S485是一个硬件层的一个标准。首先要建立这个概念。接下来我们就来给大家讲一下我们如何用单片机来实现model bus的一个通信？当然了，我们在讲这个具体的代码编写之前，我们要首先对S485有一个清晰的一个认识，对这个model bus也要有一个大概的一个了解。那接下来我们来给大家分析一下，比如说我们想从我们的一端和另外一端之间进行通信，或者我们一个设备和另外一个设备之间进行通信。我们采用的是R485通信，那这个在我们单面机这个时候应该是如何处理的呢？首先我们画一个结构框图，比如说我们这边有一个MCU。
发言人  
我们这边有一个单片机，对吧？那我们单片机要想实现485的通信。我们单片机上实现485的通信，那必须介入的是一个电平转换芯片。
发言人  
那怎么样做呢？我们这边一般来讲有一个mcu，对吧？我们这个地方应该有一个电平转换芯片，比如说我们有一个max 485。我们常用的可以用这个485的1个芯片，对吧？有一个叫做max 485的1个芯片。当然485的这种接口芯片的话，有非常多，对吧？有不同的厂家，也有不同的这种型号。
发言人  
那我们要实现485的通信对吧？那我首先我们知道我们mcu这一端是GTL电瓶或者是cmos电瓶。那我们RS485的通信，我们是485的电瓶，那就是说在RS485这个推荐的一个工业标准，或者说这个标准的一个硬件协议当中，对我们的这个485的1个信号做了一个规定。它是一种差分传输的一个信号，对吧？那我们这个时候如何把我们这个地方单端信号转成差分信号呢？我们借助这么一个电平转换芯片，这个电频转换芯片的话，就可以把我们mcu这一端的一个单端的信号。
发言人  
比如说我们这边有一个TX信号线。比如说我们这边有一根线，对吧？有一个TXD1根信号线。那这个信号线在我们单面机这一端，知道是单面机的串行口，有一个信号线叫做TXD。
发言人  
TAD这个它是一般来讲，我们讲它是一个TTL电瓶，对吧？TTL电瓶。那TTL电瓶指的什么意思呢？也就是说我们的这个TTL电瓶当中我们规定了对吧？也就是说我们在传输这个零的时候，也就是我们的逻辑零。对应的它的电气特性，对应的是什么呢？那就是我们的0伏对吧？那这个逻辑1。逻辑1，我们讲它对应的是5伏。
发言人  
但是我们这个485信号，我们前面也提到过对吧？或者说有同学也了解过，我们485的信号，它实际上是一个差分的一个信号。那我们这边的这个信号，要借助这个转成一个差分信号。它怎么转成差分信号呢？我们这边一般485知道我们出来是两根线，一个是A一个是B。
发言人  
我们这边，有两根信号线，对吧，差分信号线一根是A。
发言人  
另外一个是B。
发言人  
我们的485的电瓶特性它是怎么规定的呢？485的话它是这样规定的对吧？我们有同学的话也会了解过，那就是说485的1个信号。
发言人  
或者说485的1个电频特性，它怎么规定的？它规定了我们这个逻辑零。它逻辑零是指的什么呢？它逻辑零应该指的是我们的信号线B上的电压大于信号线I上的电压的时候，我们规定这个时候是逻辑零。还有一个就是逻辑1，对吧？我们在信号传输的时候就是逻辑零和逻辑1。1的话它是指的是我们这个I上的电压要大于B上的电压，这个时候就是代表的是逻辑1。
发言人  
当然了，具体的有一个具体的一个电器的一个规定，这个大家可以去查相关的一个标准就可以了。这个我们就大概的给大家解释一下。那就是说我们要把我们mcu这端的单端信号，通过这么一个电平转换芯片，把它转换成什么呢？转换成差分信号。这样的话能够实现什么好处呢？能够实现就是说一个是啊抗干扰能力得到一定增强，另外一方面，传输距离得到了一个很大的一个提高。那这个时候，我们就可以借助一个485信号来做一个传输。
发言人  
那它怎么样传输到另外一端呢？那就要借助485信号对吧？比如说我这边还有一个芯片，也是一个单片机，当然了也可以是计算机或者说是其他的一些设备，对吧？那这边有一个比如说有一个单片机，也是一款mcu。
发言人  
我要想借助485和这个mcu之间进行通信。我们知道MCU这端它还是TTL电瓶，那肯定是不可能和这个485信号进行连接的那怎么办呢？我们实际上这个地方还要有一个什么呢？还有一个电平转换芯片。我们这边也有一个max 485。
发言人  
有这么一个电平转换芯片。那这个电平转换芯片，我们这个数据要通过这个转换芯片进入这个MCU，所以它的信号线应该是这样子的。我们接到MCU的话，这个地方应该是接的什么呢？应该是接的mcu的。我们知道应该是它的什么呢？应该是他的。
发言人  
那就是我们这边有一个RXD的一个引脚。
发言人  
这样的话就实现从TXD发送过来到ID那这个时候怎么办呢？这个地方应该有一个连接，对吧？因为我们这个地方是基于485的通信，那这边肯定也有一根AB线。那这个地方，我们应该是A。
发言人  
那这边，我们有一个B。
发言人  
他们俩之间我们要做一个连接，对吧？那这个之间我们一般的话是用双绞线。
发言人  
我们这边大概画一个示意对吧？大概画一个示意。这个中间传输的也就是这个线，这个地方中间传输的就是我们的485的1个信号。
发言人  
因为485的是一个差分信号，对吧？那它的能够抗干扰能力比较强。也就是说在我们这个信号传输的过程当中，因为干扰的话出现在一根信号线上，也会出现到另外一个信号线上。那它们俩相互之间会抵消掉。因为它传输的是差分信号，所以它的抗共模干扰的能力会比较强。它的传输距离的话也可以做的比较远。这个就是我们的485的1个通信方式，对吧？当然了，到了这一端的话，又变成了我们的TTL电瓶。
发言人  
那这样的话，我们就实现了一个信号的一个传输。也就是说我们这个485实际上是硬件一个通信标准，它解决的就是什么呢？就是我们这个零或者是1，它如何通过485芯片转成差分信号之后，再传输到另外一端的一个问题。这个就是基于485的通信。所以我们在mcu这类开发的过程当中，我们需要用到一个电平转换芯片，也就是把我们的TTL电瓶转成485信号，通过485信号解决长距离传输以及抗干扰能力的一个问题。然后在另外一端，我们还要把什么呢？把我们这个485信号再转成我们的TTL信号，这样的话才能进到我们的mcu里面进行处理。
发言人  
一般来讲，我们这个485芯片，它既集成了，一般来说它会集成两个对吧？也就是说一个发送发送器，一个接收器。那这样的话，我们这一端比如说通过T和D进到这个地方，那这个地方是通过它的发射器，把它发送出去，发送出去到这一端，我们再把它接收过来。那实际上这里面，会集成一个发送器，也会集成一个接收器。所以，我们信号的传输还可以从这个方向，也就是说我们这个mcu也可以把数据发回过来，对吧？这个地方发过来还是TTL电瓶，它也可以转成差分信号到这一端，通过这一端再到我们这一端来。这个时候就解决了我们的一个传输的一个问题，这个地方就是我们的TXD。
发言人  
这边就是我们的RXD。
发言人  
有同学就会问，这个时候它是可以同时发送和接收吗？也就是说它是一种全双工的一种通信方式吗？那我们可以看到对吧？那因为我们这个地方中间这个传输线它是一个差分信号线。那就是说当你这一端往这一端发送数据的时候，那你这一端是不可能往这一端也发送数据的对吧？因为这个地方它是一个差分信号线共用的两根线，那它必然的不可能同时传输数据，所以它应该是一种半双工的通信。但我们一般讲基于半双工的485的这种通信的时候，我们一般讲的是两限制的时候是这种半双工的。
发言人  
如果说你用的是四线制的485，那它也可以是全双工的通信，这个大家要注意一下。同时也和你选择的这个接口芯片有关系。有的接口芯片它是支持全双工的，也就是它是四线制的。有的接口芯片它是两线制的那它是支持的是半双工的那我们要注意这个问题对吧？那这样的话我们就可以去看一下这个芯片？
发言人  
那接下来我们就来找一个max 485的芯片，来大家具体的来了解一下它如何实现我们的发送和接收的一个控制。那我们要通过一个芯片的话大概的来了解一下。比如说我们搜索一个max 485的1个芯片。当然了485的芯片的型号类型非常多。我们就简单的举个例子，这个就是它的一个芯片的一个封装，对吧？那这个是DRP的，有双列直插的那还有这种切片的，有各种各样的，大家可以感兴趣的去看一下，型号也非常多对吧？型号也非常多。那我们这边来看一下它的一个原理图。
发言人  
这个就是这个485的1个芯片，对吧？我们把它放在这，我们放大一下。这个芯片的话我们可以看到，这个时候，当这边的TSB过来的时候，应该是接到DI这个引脚对吧？然后当这边的信号出来，这时候应该从这个RO引脚接到这个RID。同时它还有两个引脚，就是这个RE和DE，我们这边还有两个引角。一个是RE。
发言人  
还有一个叫做DE。
发言人  
这两个引脚是干什么用的呢？这两个引脚是用来控制这个传输方向的，控制传输方向的。这个大家要大概的去理解一下。那就是说我们这个地方的信号线应该是什么呢？这个应该是我们的DI。也就是信号的一个输入。这个是我们的什么呢？是我们的这个RO就是信号的一个输出。那这样的话大家就掌握了这个芯片的一个用法，对吧？因为它的引脚你看除了这一角IB之外，就有一个电源引脚了。
发言人  
那这个时候我们来看，怎么样实现传输的呢？那就是说我们这一端的信号1或者是零，通过这个D进到这个里面，通过它里面的一个控制，把它转换成什么呢？插飞信号传输到这个信号线上。那到了另外一端，到了另外一端，我们再把这个差分的信号转成什么呢？转成我们的TTL信号，然后传给mcu。解决了从这一端到这一端的一个传输问题。
发言人  
这个时候我们什么时候是从这个芯片制从这一端往这一端传呢？又什么时候我这一端又在做接收呢？就是由这两根信号线来做控制的。所以这两根信号线我们叫做控制引脚，对吧？也就是控制你的传输方向的控制传输方向的。所以我们的485的通信和我们前面讲的URT的通信唯一的区别就在于我们需要控制它的一个传输方向。当然了，你也可以借鉴于硬件电路来实现自动换向。
发言人  
我们一般来用的时候可以用软件来控制它的一个方向。那怎么控制呢？我们可以再找一个RO口，这个时候也就是说我们再可以用一个单面机的R口来控制这个信号线。也就是说把这两个信号线接到一个单面积的R口来控制。那这个时候我们这个信号线为1和为零的时候，能够驱使的就是这个芯片是接收状态还是发送状态。这个就是我们可以把它和我们URT结合在一起了。
发言人  
也就是说当这个信号线上一般来讲为1的时候，为高电频的时候，我们把这两根线，也就是我们给大家标一下，我们把这两根信号线接到一个单面积的R口上去。那当这根口线上为高电频的时候，就代表的是我们这个max 485进入的是发送状态。当这个引脚我们是低电平的时候，代表它是接收状态，这个大家要注意一下。
发言人  
那这个时候，我们就实现了一个半双工的一个通信方式的一个控制，对吧？那大家在应用的时候要注意一下。那这个就是我们的硬件层要解决的问题。
发言人  
有了硬件层之后，我们就可以去来讲我们的软件层的一个通信协议了，对吧？软件通信通信协议也就是我们在485通信的过程当中，在工业上经常使用的是一个软件层的一个通信协议，是选用的这个model bus。那为什么选用mode bus呢？那就是说mode bus它是大家都遵守的一个大家事先约定好的一个格式或者是规则。
发言人  
那这样的话我们就实现一个好处。比如说我们在发送数据的时候，我们刚才讲我们软件主要是解决发送数据要实现什么目的的一个问题，对吧？比如说我这个地方我要发送一个数据，比如说我想发送一个数据，比如说是比如说我从这一端发送一个数据，比如说我一个字母，我发送一个I我发送一个I要干什么呢？我想实现的目的就是发送这个I之后，能够让这一端接收到这个I之后，能够去驱动一个比如说一个发光极管点亮，或者是驱动一个蜂鸣器鸣响。那这个时候我发送是I但是另外一个人编写代码的时候，他可能会我不发送，他可能实现同样的目的，但是他发送这个字符，他可能发送一个他发送一个。比如说他发动一个B来代表的是驱动蜂鸣器，或者是驱动的一个LED灯。
发言人  
那这样的话，就是说不同厂商生产的设备，它遵循的协议不一样，那大家的话就没办法干什么呢？就没办法相互工作，相互配合。比如说我买了这个厂家的这么一个一个一个设备，买了另外一个厂家的一个设备，它都是基于485的1个通信。但是他们的软件协议不一样，那他们俩之间就没办法配合工作，就带来很大的一个不便。那这个时候，我们就有了这种标准的一个通信的一个协议。也就是说我们要能够解决的就是说大家都遵循某一个统一的一个格式，对吧？
发言人  
统一的一个通信的一个规约。这样的话，不同厂商之间的产品就能够相互的一个配合。比如说我在这一家买了一个主机，在另外一家买了一个是设备或者是从机。那他们俩之间遵循同样的一个通信标准，那他们俩就很容易相互配合的工作，对吧？否则的话你买了不同厂商的主机和不同厂商的从机，那他们之间的话通信约定不一样，那他就没办法去配合工作。
发言人  
也就是说你发给他的东西，本来他比如说我们这个地方是作为主机来发送数据的。比如说我这边的协议，比如说我发送了一个I但这一端，他并不认，他不知道你发的I到底是什么含义。虽然你在硬件层上解决了这个数据的传输问题，但是在软件层这一方面，它并不能识别你发送这个东西的目的或者是意义是干什么。这样的话就带来很大的不便。
发言人  
工业上有这么一个标准叫做model bus通讯协议。我们需要去了解一下mode bus通讯协议。Model bus我们一般来说是用于主从通信。我们这边就要画一个大概的一个框图，先来解释一下我们基于X85的1个mod bus的通信协议的一个硬件的一个环境。那就是说我们一般在搭建model base通信的时候，我们一般遵循的是主从通信。我们这边，一般来说在一个系统当中，会有一个主机。
发言人  
那我们这边是一个主机，同时我们如果说是借助了一个485的1个通信，对吧？我们有一个主机，在这个主机我们借助485通信的时候，有同学也清楚，我们在485用2线制的半双工通信的时候，它支持的是一主多从的通信方式。也就是说我们在这个485的总线上可以挂什么多个设备？可以挂多个设备，大家要有这个概念，就是说它支持的是半双工的，可以支持主从的一主多从的一种通信方式。就是说我们这边有两根信号线。
发言人  
而在这两个信号线上，我们可以挂多个设备。也就挂多个层级。
发言人  
我们画一个简单的一个示意图，对吧？那这样的话，比如说我们这边是一号从机。我们这个是从积。这个一号。我们这个，就是从机二号。
发言人  
这个，比如说是三号。
发言人  
当然了，这后面的话，还有其他的统计，对吧？
发言人  
还有其他的层级，那这个时候可以挂很多个层级，对吧？那至于一个主机上面，就是说这个总线上可以挂多少个层级，当然了是和你的这个驱动器有关系，也就是你选择的这个485的这个驱动器有关系。那这个时候，大家也可以去看一下，不同的驱动器它能够支持的这个节点的个数也是不一样的。这个大家可以去打开它具体的芯片手册去了解，对吧？可以去打开具体的芯片手册去了解一下它可以支持多少个节点，对吧？可以支持多少个节点。那这个时候大家可以自己去看啊，这个我们就不再挨个的去给大家去展开了。这个大家在他的芯片手册当中都会有一个具体的一个介绍。大家在用的时候，一定要去看器件手册，对吧？
发言人  
大家注意一下，这个时候，我们这边，比如说这个地方就是A对吧？那这个是A这个是B。同样的那这边的话就是。这个就是我们的。B这边也是一样的。
发言人  
那我们在理解这个mod bus通信的时候，一定要首先有一个概念，就是我们model bus通信协议，它一般来说是支持的是主从通信的一种方式，对吧？主从通信的一种方式。那我们在解决主从通信的方式的时候，我们要解决这么几个问题对吧？因为我们所有的设备都是挂在485的这个总线上的，我们叫做总线对吧？485的总线就是你可以挂在上面，我也可以挂在上面。那我们主机要想和这些从机之间进行通信的时候，我们可以借助于model 8的通讯协议来完成这么一个通信的一个过程。
发言人  
我们一般来讲，如果说主机和下面的从机进行通信，那我肯定就是说首先要找到这个从机，和从机之间建立一个通信关系，对吧？那这样的话，总线上挂了这么多个从机，我们怎么去找呢？那我们可以借助于寻址，对吧？也就是说不同的机器，不同的统计设备在总线上的时候，它会有一个唯一的一个地址。那这个地址是不同的。我们就可以借助于这个来实现这个器件的一个识别，对吧？那同时我们还借助于其他的一些方式来保证我们通信的一个稳定和可靠，这个大家要注意。
发言人  
那我们如何实现这个呢？大家要注意一下，我们硬件层这个地方我们提到了硬件层就借助的就是我们的RX485。软件层我们借助的是什么呢？是我们的这个model bx通信协议，这个大家一定要先理解清楚。
发言人  
接下来我们知道我们借助半双工的时候，也就是二线制的485的时候，可以实现的就是我们这种主从通信的一种方式。这个时候大家要想理解model bus，就是我们现在还没有提到具体的model bus协议，但是你要想理解mode bus通讯协议，那你首先要遵循这么几个规定，或者说这么几个事先的一个约定。什么约定呢？那我们给大家大概的来理一下。
发言人  
第一个大家首先要理解，第一个我们在系统当中。在系统当中，就是说在整个的总线系统当中，它只有一个设备。是主机，也就是我们支持的我们的M把子这个485通信支持的是主从通信。这个一定要先理解清楚，就是说在通信的时候，我们系统当中只有一个是主机，这个一定要先首先明确。这个是第一条对吧？大家一定要先注意一下，就是说我们在系统通信的时候，有且只有一个主机，其他它的都是从积，这是第一个。
发言人  
第二个证，我们需要注意的一个地方就是说我们系统当中的从积我们也约定好。系统当中的乘积，它不可以主动的。向主机发送数据。
发言人  
就说你在一个系统当中，我们的设备或者是从机，你不能主动的向主机发送数据通信。就相当于是我们这个教室上课一样。就是说在上课之前，如果说主界就是老师没有说话，就是说没有去开始上课，也就是说没有主动的去发起通信的时候，你的从机是不能够往主机发送数据的，也就是说学生是不能够讲话的。这个大家要注意一下，我们一定要注意在485通信的过程当中，也就是在我们的这个mod bus通讯协议里面规定这么几个东西。一个系统当中只有一个设备是主机，它支持的是这个主从通信的一种方式，对吧？另外所有的从机，也就是所有的从机设备，他不可以主动的向主机发送数据。
发言人  
那有同学说我们主机如何去和同级之间进行通信呢？那就是说我们如果说要想和同学进行通信，那必须是主机主动发起通信。因为我们主机和从机通信无外乎两个方面。一方面就是主机往从机发送数据，另外一方面就是主机向从机要数据。那这个时候，它怎么样来实现的呢？它全部由主机来主动的发送数据帧来实现。也就是说我们主机主动的发起通信，就是说系统当中的主机和从机上电之后，它都应该属于是这个接收状态。当我们的任何一次数据的发起的时候，都应该由主机来发起。那也就是说我们第三点就是说系统上电之后。
发言人  
就是所有的设备，如铜设备都应该是什么呢？都应该处于是我们叫做监听的一个状态，就应该处于是监听总线的一个状态。
发言人  
也就是接收状态。
发言人  
也就是说我们上电的时候，我们所有的主机或者是从机，它都处于接收状态。这个时候都可以去监控总线或者是监听总线。这个是第三点需要注意的那当时我们想要发送一次通信怎么办呢？那就是说如果说当前如果。如果想要实现一次通信。如果想要发起一次通信。
发言人  
都必须是由主机发起。
发言人  
就是说如果你要想实现通信，主机和从机之间的通信，必须由主机主动发起通信。从机是不能够主动的发起通信的那我主机主动发起通信，我们要干什么呢？也有可能是像统计发送数据，也有可能是给统计要数据。
发言人  
这个我们就可以借助我们接下来要介绍的这个通信协议来解决大家要注意的一个点就是说我们任何一次的数据通信都是由主机来实现的。也就是说就是任何一次的通信。或数据交换。都必须。由主机来发起。这个是大家要理解的对吧？我们这样的话理解了这个，你才能够理解我们后面讲的model bus通信协议，对吧？
发言人  
那就是说为什么要实现这个功能呢？就是说我们主机和从机之间进行通信，那你比如说你的同期大家都想往上面去发数据。那比如说你也发数据，那我们知道我们的总线只有这两根线，那大家都来发的话，那到底是谁发给主机的数据呢？那就没办法去判断了，对吧？没办法去判断了。所以我们这个485通信，它并没有一个我们的这么一个优先级的一个判断，或者优先级的一个裁定的一个机制在里面。
发言人  
这个大家一定要注意，它不像看总线，我们讲看懂线，它是一种捉组的一个通信方式。它有一个总线仲裁的一个机制在里面可以实现的。就是说总线仲裁来保证哪一个当前时刻作为主机来发送数据。但是我们的485通信它并不支持这个，所以它只支持是主从通信。大家一定要理解这个概念，就是主从通信。
发言人  
在主从通信的过程当中大家要注意。那就是说当前在我们主机要想实现和从机之间进行通信的时候，数据的发起方必须由主机来发起。任何从机它不能主动的发起数据，你的任何重机不能主动的往主机发数据。你要想实现数据的收发，必须有主机主动的发起通信。那我们可以通过主机发数据到总线上统计来监听总线。
发言人  
从机接收到总线之后，我们可以借助于我们的model box通信协议里面的寻址，真使我们重机知道是发给自己的。他发给自己之后，他会把是主机让他接收命令，还是他要把数据返回给主机，然后他再来做响应。那这个时候，我们知道mode bar通信协议遵循的一种方式是一种我们叫做问答和就是问和答的一种方式，也就是询问和应答的一种方式，就是主机询问从机应答的一种模。是这个大家也要能够大概的理解，这个就是第四点对吧？
发言人  
大家要注意就是如果要发起一个通信，必须由主机主动发起，任何一次通信都必须由主机发起。那主机发起的时候，我们就需要注意了，就是主机要想发起的话，必须遵循这么几个步骤。就是首先主机要发起数据的时候，主机首先要切换模式，对吧？因为我们上电的时候，他们都是什么接收模式，那我们要切换成发送模式。那你主机接发送模式之后，那就是说你去发送数据对吧？然后去发送我们的数据包吧？或者数据协议发送我们的数据包。你发完之后你要立马。要转成接收模式。
发言人  
你转成接收模式，这个时候我要接收的是什么呢？接收从机的应答。所以，我们刚才讲我们的它的通信方式的话是。主机我们叫轮巡。从机应答的一种机制。就它的通信的机制，我们model base通信的一个机制。是主机轮询，从机应答的一种机制。这个大家也要能够把它理解清楚，对吧？你理解了这个，我们再来讲通信协议，可能就会比较清晰的能够认识对吧？
发言人  
能够重新的认识。比如说我们当前我们主机想要和从G2之间进行通信，那怎么办呢？我首先主机要改成什么发送模式，怎么怎么切换发送模式呢？我们可以借助这个引脚，把它切换成发送模式。比如说这个是主机切换成发送模式之后，我就发送数据，那通过这个D把数据发送过来，发送过来之后，它会转成我们的这个差分信号发送出去。比如说这个是你的二号机，那二号机会接收数据对吧？
发言人  
我们知道它遵循的是一种什么方式呢？是主机轮询重击应答，也就是主机发数据统计必须要给出应答。无论是主机要求你干什么，或者给你命令，或者主机给你要数据，那你都要给从主机要应答。那这个时候重机一旦接收到之后，比如说二号机接收到之后，他也知道是发给他的了。它解析完这个命令之后，它必须把它的一个应答的数据帧返回给主机。那这个时候你主机要能够接收，对吧？
发言人  
所以你主机要干什么呢？你发完之后，主机要立马转成接收模式，等待从机的应答。那这个就是它的一个大概的一个通信的一个机制，对吧？通信的一个机制。
发言人  
当然了，我们在model bus通信的一个时候，我们主机的寻址帧的格式，一般来说有两种传输方式，一个叫做rtu一个叫做阿斯克码。我们在工业上常用的就是这个RTU，也就是16进制方式。所以我们待会儿举例子的时候，也会以这个16进制的方式来给大家做举例子。所以大家要能够大概的一个理解，对吧？
发言人  
大概的一个理解就是说我们主机和从机通信无外乎就是两个方面。一个就是发命令给同机，告诉他你要干什么，你要执行哪些操作。另外一个就是从从机要数据，也就是说你要把某些数据传给我，我需要用，这个大家要注意一下，这个就是它两个方面。
发言人  
但是无论是哪一种通信，都必须由主机主动发起。从机只有应答的份儿，从机不能主动的发数据。就像我们上课一样，比如说我们传统的课堂就是这种填鸭式的课堂。那就是说老师讲学生只能被动的听，只有老师要求你回答问题的时候点到你的名字，你才能够去站起来回答问题。而且不管你会还是不会有就必须要执行，就是必须要给一个应答。这个就是主机发送命令，或者是发送数据，或者是要求从机返回数据，从机要给出相应的一个应答。
发言人  
那如何理解这个通信呢？我们前面有同学可能会了解过mode bus。Model bus协议当中，它会规定这么几个东西，我们给大家大概的看一下。有这么几个通信的一个报文格式，也就是我们的地址码、功能码、数据区和校验码。但是很多同学对这一块并不是特别的理解，对吧？要想深入的理解这个，我们可以借助一个工具。在讲这个工具之前，我们这边大概的提一下关于这个电路的一个设计对吧？电路设计的话，大家可以在网上去查找相关的一个电路，那我们这边可以把这个电路也摘抄过来。
发言人  
大家感兴趣的话，也可以去查找这种电路，对吧？这个网上来说会有很多这种标准的一个电路。一般在器件的芯片手册当中也会有具体的一个介绍。
发言人  
当然了，我们这个电路只是一个对比较简单的一个电路。如果说你是在工业现场环境比较复杂的场合，那你需要增加一些保护措施，对吧？比如说我们在这一端，包括这一端，那在mcu这一端，一般来说在工业试验场的话，如果说你的环境比较复杂，我们可以增加光电耦合器。也就是说mcu这边的信号过来之后，先经过光耦，再接到这个芯片，使它电器上产生一个隔离。在这一端，我们为了使工业现场的一些干扰，不要损坏我们的接口芯片，我们也可以增加一些防护措施，比如说加一些TVS管，加一些共模电感，再加上一些其他的一些措施。这个大家可以感兴趣的去查找，网上都有这种相关的一个典型电路供大家去应用，对吧？那这个大家感兴趣的可以去查一下，我们这个就不再做过多的介。
发言人  
好了，接下来我们通过一个工具来给大家演示一下model bar的通信的一个具体的一个通信的一个机制。也就是说它到底是怎么通信的，或者说它的我们刚才讲的这个寻址帧或者说是数据包到底是怎么样的一个方式？我们虽然刚才提到过了，它主要有这么几个方面来构成的，也就是我们的地址码、功能码、数据区和校验码。也就是说我们在用model的通信的时候，它遵循的是这么一个数据包的一个格式，就是主机往从机发数据或者说主机要求同机返回数据的时候，那都是用这么一种通信的一个格式。那这个格式当中分别代表什么含义呢？
发言人  
Mode bus通讯协议当中的第一个地址码就是来区分不同的设备的，就是区分不同的统计的那我们刚才讲了在总线当中不同的设备它有一个唯一的一个地址。比如说你这个地址是一，这个地址是2，这个地址是3。那我们在主机在发送寻址命令帧的时候，我们在寻址命令真的第一个就是地址码，那你的重击我们知道能够接收到主机发送的命令。那接收到第一个的时候，他就可以去先判断它是不是发给自己的对吧？通过第一个地址码就可以判断是不是发给我的。如果要是发给我的我再来去区分它的功能码和它的数据区，去做相应的处理。如果说不是发给我的，我通过这个字节就能够判断出来不是发给我的，那我就不会去接受后面的数据了，我就不会处理后面的数据，对吧？这个就是它这个地址码的一个作用。
发言人  
另外一个就是它的功能码，在model bus当中对功能码做了一个规定对吧？我们常用的就这么几个功能码，010515030616？那这几个功能码，前面这三个是针对未操作的，后面这几个是针对字节操作的那这个我们待会儿的话会给大家做一个具体的一个演示，对吧？具体一个演示这个大家也要大概能够理解一下。这个时候有的功能码后面就是跟的是数据区，那数据区的个数可以是N个字节，是不确定的那地址码是占一个字节，功能码也是占一个字节。并且功能码是这个model bus协议当中，是把它做了一个具体的一个规定，不是我们随意的，它是规定好的，对吧？有些功能码是我们常用的，已经规定好了。当然了也有一些是保留的。
发言人  
这个大家用的时候，可以去查相关的一个model bus协议的一个具体的一个标准。我们实际上常用的就这么几个，我们一般来说常用的就是03、06和16这么几个功能。大家把这几个掌握，其他的也就能够基本的掌握。
发言人  
地址码的话就是占一个字节。我们在通讯地址当中的model box当中，它规定了它的地址可以是247个，对吧？也就是从1到247同时规定的地址零是广播指令，也就是说所有的设备都能够运行。但是不回应一个指令，这个时候是地址0。因为我们刚才讲了，如果说是地址零的话，就相当于是广播，就所有的从机它都能够接收到。但是它我们也在协议当中规定好了，但是你不用回应其他情况下，那同机只要是接收到了，他必须做响应，也就是我们刚才讲的询问和应答，大家要把这个机制印入脑海当中，这个就是这个东西。
发言人  
那接下来我们来演示一下。比如说我们想要实现这么一个通信，我们可以借助这么一个工具。大家可以去网上去下载这么一个工具，叫做model bus的一个炮，model bus的一个slava。这么两个一个作为主机，一个作为这个从机对吧？作为从机，那我们要想实现这个演示怎么办呢？因为这个里面它是遵循的标准的mod bus通信协议，对吧？
发言人  
比如说这个是作为从机，这个是作为主机，那就是我主机要发送一个命令帧，那从机肯定是要应答的对吧？肯定是要是应答的那我们举这么一个例子。比如说我们举一个例子，比如说我们举这个03这个功能码。那这个03功能码，比如说我的主机要发送这么一个数据，我看看他统计是如何返回数据的那我们来具体的通过这个来给大家分析一下。
发言人  
那我们首先要做一个连接。那这个时候，我们想给大家演示的话，我们可以借助一个虚拟串口。比如说我把这个连接到一个虚拟串口，我这边有一个虚拟串口，有一个串口，串口的话，我们选择的是我们这边有一个虚拟串口com 2 com 3。我提前安装了一个虚拟窗口。比如说我们这边是一个com 2的com 39600的波特率，八位数据位，没有奇偶校验位，一个停止位。我们点击这个OK从机这一端我们也是一样的，我们设置成了com 3到com 2，这样的话他们俩是一对的对吧？
发言人  
900的波特率，八位数据位，没有机构交验位，一个停止位点击OK，我这个地方要想设置的话，我可以怎么办呢？比如说我要用的是这个，我要设置一下对吧？我们的设置我要读的从机地址是一。比如说一个从机地址是一，我用功能码03。功能码03的话我们要读保持寄存器03这个功能码。我们来看一下就是常用的这几个功能码。
发言人  
大家要了解一个是0303叫做读保持寄存器。至于什么是保持寄存器，我们大家不用关心对吧？这个是PLC当中的一个概念。我们就用0303的话，就当然是读寄存器，也就是说是主机想要读从机的数据。也就说我要从机，你要返回一些数据给我。比如说你的从机设备是一个温湿度的一个传感器，那我们就可以借助于什么呢？借助于主机发03这个功能码，要求重新返回温湿度的数据，那这个就是相当于是主机读从机就是03。
发言人  
另外一个功能码，我们还有一个叫做06，叫做写单个寄存器，对吧？叫做写单个寄存器。那写单个寄存器的话就代表是主机要写命令给统计，但是只能写一个寄存器的命令，那这个叫做写。那你要想写多个数据，它还有一个叫做这个十六，这个16，就是写多个寄存器，那这个就是写多个寄存器的一个命令。所以我们在常用的功能码当中就这么0003、06，一个是读，一个是写，另外一个还是写一个是写多个。一个是写单个读的话，可以读单个，一个是多个。
发言人  
我们待会儿给大家演示，我们先用03来表示对吧？我们要读寄存器，读寄存器你要读的就是寄存器的地址，你要从哪个地址开始读？比如说我从零这个地址开始读，比如说你要读几个寄存器呢？比如说我读两个，我们先读一个。给大家简单一点，我们先读一个寄存器，那间隔时间我们可以用这个我们剩下的我们可以不管它了，对吧？那就是说读一个寄存器对吧，读一个寄存器，那我们把这个先给它OK那这个时候我们就地址设置好了对吧？这个地址大家注意是我们寄存器的地址，寄存器的地址，那这个实际是我们的器件地址，也就是slave RD器件地址，也就是我们刚才指的这个地方的一个地址码。那这个地方03就是我们的功能码，数据区这边，就包括我们的寄存器的地址，还有就是寄存器的个数，这个我们待会给大家来演示对吧？
发言人  
我们来看一下，我们比如说租两个，这样的话大家更容易理解一点。我们点击OK，这个时候要读的是从积对吧？它要读两个寄存器，那从机的话我们要给它设置一下统计，我们这个地方要给它设置一下，对吧？
发言人  
统计的话比如说我们把这两个寄存器的地址给它改一下，把这个值给它改一下。比如说是一，这个D等于一的值是2。我们可以看到我们这个地方就实现了把一和二读过来了，对吧？一和二读过来了，因为我们就读的就是寄存器零和1对吧？寄存器0和1，所以它把它读过来了。
发言人  
那到底是怎么读的呢？我们可以通过这个地方来看看它的具体的一个数据，对吧？具体的一个数据。我们可以把这个数据拷贝出来，我们看看主机怎么发送，从机怎么应答的。它这边是实现了多次，我们随便拷出来一次的那我们看主机是我们看03这个功能。
发言人  
那这个时候，是主机发送的对吧？主机发送这个是发送的第几次，这个我们先不管它，那我们看它怎么发的。发了一个01、一个03、一个0000、一个0002。那这些东西分别代表什么含义呢？我们可以看一下，第一个是代表的是地址码。也就是说我是实现的是和哪一个层级设备进行通信的。我们不同的层级我们刚才讲了会有具体的不同的设备地址。
发言人  
这个就是地址码，这个就是我们的功能码，就是要干什么？我们03这个功能码规定的是什么功能呢？03这个功能码我们代表是读是要读从机，也就是说读从机这个就是03这个功能。
发言人  
那你要读的话是从什么地方开始读？要读多少个数据呢？这个就是我们的这个寄存器的一个地址，也就是寄存器。起始地址就是你要从哪个地方开始读寄存器的起始地址。
发言人  
这后面这个是寄存器的一个个数，要读多少个寄存器？你就读多少个？读多少个寄存器，寄存器的起始地址读多少个寄存器？这个大家要能够大概的去理解一下，对吧？大概的去理解一下。
发言人  
还有一个最后这个地方，最后这个地方就是我们的CRC校验，对吧？我就最后是ARC校验。通过这个，我们也能够看出来一个问题。我把这个放小一点字体。
发言人  
我们从这个地方能够看出来看出来什么问题呢？
发言人  
我们这个地址是八位的。是八个比特。然后我们这个功能码也是一个字节，是八个比特。然后我们这个寄存器的起始地址它是16位的。因为这个model 8的协议主要一开始发明的时候，是针对的是PLC操作，对吧？大家一定要注意。这个也是16个比特的，只不过现在在我们的嵌入式设备当中是经常使用的。
发言人  
我们这个CRC16也是16个比特的，是CRC16的一个校验。所以你可以对应一下对吧？那这个主机发送的时候，地址码，这个就是我们的地址码？然后对应的这个功能码，功能码是规定好的，就是在model bus当中做了一个标准的一个规定，就是规定的功能码的一个含义吧？就是代表这个功能码代表什么？
发言人  
此那这个就代表的是读无从机设备。读从机也就是要求从积，实际上就是什么呢？也就是要求从积返回这个数据对吧？返回数据也就是要求同机返回一些数据，那到底返回什么数据呢？我们待会儿来具体的来看对吧？
发言人  
那这个时候，他要求的返回数据返回多少个数据？你到底要返回什么数据呢？它从这个寄存器的起始地址开始读两个寄存器，所以这个地方最后这个校验是标准的一个方式，我们就不管它了。我们有标准的一个算法对吧？大家到时候直接借鉴一下就行了。
发言人  
那这个时候，我们看重机重机怎么返回的对吧？统计怎么返回呢？这个地方是统计返回的数据，我们把它拷贝过来来分析一下。
发言人  
那就说它遵循的是主机发送数据，同机必须要应答，就是说主机发送从机应答，那这个时候是同机的一个应答。宏基的应答，我把它写在这。
发言人  
那从机应答它遵循什么格式呢？它也要遵循这个格式，它遵循的是什么呢？首先是地址码，就是它主机发送数据的时候是有一个标准格式的。你重击应答的时候，也要遵循一个格式。
发言人  
那03功能码它的格式是什么呢？就是地址码，是功能码。是什么呢？你看这个地方是地址码，是功能码。
发言人  
我们把这两个标红，然后接着接着这个地方你可以看一下对吧？接着这个地方是什么？是字节数，是字节数，接着是字节数。然后接着就是我们的数据，一个是数据一对吧？一个是数据2，然后最后是CRC。最后是CRC校验，这个大家也要和它对照起来，对吧？
发言人  
功能码字节数，然后数据一、数据2CRC。这个数据一和数据2，这个地方的数据就是我们刚才在这个地方寄存器里面也给它填了数据，这个是寄存器零对吧？寄存器一这个他是提前给我们准备了这么几个寄存器，那这个是一。你如果说这个地方改了值，比如说我改成一个20，这个呢比如说改成一个40，那我们可以看一下，那这个时候，我们的这个主机这一端实际上就把这个值也跟着调整了，对吧？就是说主机在读这两个寄存器。我一旦发送一个命令帧，我一旦发送这个命令真大家可以看到这个就是寻址命令帧，对吧？我发送这个寻址命令帧之后，那统计就把这个数据给它返回过来了，对吧？
发言人  
给它返回过来了。所以我的主机这边的数据就跟着这么做了一个更改。那这个时候就是主机发送命令，重击应答命令对吧？应答命令。那这个时候，地址码，那重新应答的时候，最新的格式，就是地址码还是地址码。
发言人  
03的时候，功能码还是03，接着他返回的什么呢？是字节数。因为你这边要读的是什么呢？我们讲它要读两个寄存器。一个寄存器我们刚才讲了一个寄存器的数据是16个比特，所以它读两个寄存器，那正好是占四个字节对吧？那正好两个寄存器，每个寄存器它都是16位的。所以这个地方它给出的格式你也能知道，那这个地方是一个八个比特，功能码的话也是八个比特。
发言人  
那字节数的话，那你读多少个寄存器，那就是寄存器数乘以2，对吧？那寄存器。应该是乘以2就是字节数。但是后面就是你的数据，后面就是具体的数据，对吧？
发言人  
我们刚才读的寄存器里面的值是幺是2，所以就是返回1和2。你现在的话这个寄存器里面的值是什么呢？是我们的这个20和40，所以它返回的就是20和40的1个16进制的一个编码，对吧？我们这边写的时候是十进制写进去的，就是这个软件它是十进制的那这边的话你可以看到它就是这个16进制的，你读的这个命令真是一样的没有变。数据发生变化了，那你这个地方返回的数据，那这个时候我们返回的数据，我们再可以看一下是这个值。
发言人  
同样是四个字节。然后接着是数据。0014对吧？0014那就是20，对吧？这个是十六，16加4就是20，对吧？那这个呢大家要能够理解这个东西。那这个就是它返回的一个数据，对吧？
发言人  
当然了你这边统计的数据，比如说你这边是一个温湿度传感器，你又检测一个温湿度传感器，你的数据又发生变化了。你的温度发生变化了，比如说你变成变成50了，这个地方变成60了。那这个时候我的主机每隔一段时间会来问一次，对吧？那我会来寻址，那你这边我也会发生变化。那这个时候就相当于读到了你的温湿度传感器的数据。这个大家要注意一下，这个就是我们的03这个功能。大家能够理解03这个功能，但有同学这个时候我们主机发送和重新接收，它是如何识别这一包数据的呢？我们靠的是时间间隔，靠的时间间隔就是超时接收的一种办法。
发言人  
实际上在model bus的通信协议当中，实际上是规定好了，对吧？那就是说我们这个地方它实际上是规定好了一个数据通信，这一包数据和一包数据之间的一个最大的一个时间间隔。他一般来说是用的是三个我们的这个字符时间三个字符时间，那三个字符时间我们就可以去算，对吧？比如说你是9600的波特率，他用的是三个字符时间来做这个断针的。有传三个字符的时间。这个都是有规定的对吧？三个字符时间你可以算这个时间是多少。
发言人  
那就是我们讲我们刚才提到过对吧？我们在设计这个通信的格式的时候我们在设计这个通信格式的时候，也就是我们在连接的时候。我们刚才说的是90的波特率，比如说八个数据位，没有机构校验一个停止位对吧？我们还有一个起始位，也就是一个数据一个字符串。一个字符我们是十个比特。我们十个比特的话，我们知道那三个字符就是3乘以十个比特对吧？就是30个比特，那它占多长时间呢？我们一个比特需要传输的时间，我们是一除以9600。那这个时候就能够计算出来我们这个时间，对吧？计算出来这个时间我们可以算一下。
发言人  
大家可以算一下，对吧？我们是30，要除以9600。那等于大概多长时间呢？一二三大概是三个毫秒，对吧？大概是三个毫秒。所以我们在程序当中在做断帧的时候，也就是说断这个数据包的时候，我们一般是用十个毫秒的时间，对吧？
发言人  
就是超时时间用十个毫秒，那就能够保证的就是说也就是说你这一包数据当中传输的过程当中，它的时间间隔超过了十个毫秒或者超过了三个毫秒。我们就认为它是一个新的数据包。这个就是model base当中做了一个规定，对吧？同时model base当中实际上还做了一个规，就是这一个数据包当中的这一个字符和字符之间的时间间隔不能超过1.5个字符时间，已超过1.5个字符时间，他也认为是出错的。
发言人  
所以大家在用的时候要注意一下，就是我们断针的时候，断收集包的时候，为什么我们用十个毫秒或者多少个毫秒来断？就在于model bus在协议当中规定的时候也规定了。就是说你这个数据包在发送的时候，你这一包里面这不同的字符之间在发送的时候，字符和字符之间的时间差不能超过1.5个字符时间。那你如果说这一波发送完了，你没有接着发。比如说你发送到最后这个不发了，那这个时间间隔肯定是大于三个毫秒以上的时候。
发言人  
我就认为下一波再来数据的时候是新的数据包，就是说数据包的一个缎包，它也是有一个规定的，这个大家理解一下是所以我们一般来说在model bus的协议当中的话，我们就没有再有针头和针尾，对吧？就不再有数据针头和数据针尾，而是靠时间来断，真的靠时间来断的，这个就是我们这个03功能码的应用。那你要想学这个东西，肯定是要借助人家这个东西，或者借助这个软件，或者你就找一个别人做好的产品来去演示一下，对吧？我们后面的话会拿一个温湿度传感器给大家来演示一下。这个就是03功能码。
发言人  
03功能码最新的机制就是主机发送的数据格式，就是地址码加功能码。地址码加功能码加上了这个寄存器的起始地址，加寄存器的个数，CRC校验，这个就是它的标准的一个格式。你要想读多少个寄存器，那你就从寄存器的起始地址给一个个数。比如说我们这边还可以再重新演示一下。比如说我现在不想读第零个寄存器和第一个寄存器了，对吧？比如说我们这个地方可以这样子来规定，对吧？你可以做一个产品，做一个产品当中你可以做一个地址，对吧？你比如说你的计算机地址0001，那这边是温度，是湿度，比如说0203，那这两个我们也改一下，比如说是我们的这个压力。
发言人  
我们先来讲如何读的，我们待会再来讲写的，比如说是压力和流量。比如说你想读压力和流量，那你要读的是这个寄存器，对吧？这个地方就是我们讲的寄存器地址。但这个寄存器地址大家不要，它不是一个实际的一个地址，对吧？它不是一个实际的物理地址，而是一个虚拟的一个地址。
发言人  
至于这边出现的这个40014002这个东西，这种是我们PLC当中的一个组态地址。这个是十进制的一个地址，我们这个地方地址是16进制的一个地址，所以在我们程序当中，实际上你不用管它，对吧？这个地方实际上就是一个虚拟的一个地址。
发言人  
我们实际上程序是靠判断这个值来得到你是要读什么东西的对吧？你要读什么值的。就是说比如说我一个温湿度传感器，我采集的温湿度的值，我会放在一个变量里面。当我接收到命令帧的时候，出现是从这个起始地址开始，然后要读几个字节，读几个寄存器，那我们就可以去判断对吧？我判断是从这个地址开始的，然后他读两个寄存器的地址，那我就知道他要的是这两个数据。这个实际上是靠我们的软件程序做代码判断的，它不是一个实际的物理地址。大家要理解这个概念，对吧？
发言人  
理解这个概念，比如说我们这个地方的一个温度湿度，我们不读了，我想读这两个，那我要读这个我怎么办呢？那我们就可以这样子来操作，吧？那就是说我们在读的时候，同样是03这个功能码，我读的时候不是从寄存器零开始读了，我要从寄存器地址二开始读，同样的也是读两个对吧？同样也是读两个，那就读寄存器2和3这2个地址对吧？我们刚才讲的是零和1，然后从二开始读读两个，那就从这个地址开始读读两个寄存器，那就是说读我们这边的压力和流量，那你读的时候，你看这个地方的值，我们这边统计还没有设置之前，他读的肯定是零，因为你这边是零和1，我们要设置这两个对吧？
发言人  
因为他现在发的命令真我不是要这两个数据了，我们要的是这两个压力和流量，比如说我们这边改一个，比如说100。然后比如说这个地方是50，那这个时候它就可以读过来，对吧？那这个时候他读的这个命令J是怎么发的呢？你可以去看一下对吧？那这个时候我们就很容易去理解了，对吧？那我们再我们把它拷贝出来，我们来对照一下吧？那这个时候他发送的是什么呢？就是我们第二个。
发言人  
你一个功能码都搞清楚了，其他的都差不多。那你看他从寄存器的0002这个寄存器地址开始读，同样是读两个字节。那这个时候我们统计要返回数据，对吧？那它怎么返回的呢？它返回的格式又是什么呢？和我们刚才这个是一样的，对吧？可以看一下它返回的数据的格式。
发言人  
首先是地址码、功能码，还是返回什么四个字节的数据。紧接着是四个字节的数据，最后是椒盐味对吧？那这个值就是我们的100对，100就是16乘以6，再加上四正好是一百。这个就是我们后面这个50对吧？这个就是它返回的值，所以它的格式是约定好的，你怎么读我就怎么回，对吧？你03功能码它只能按照这种方式来进行回数据和读数据，这个都是提前约定好的。大家一定要理解这个东西对吧？要理解。
发言人  
所以你看这个地方是地址码，功能码读从哪个寄存器地址开始读，从0002开始读读两个字节。那我们在事先约定的时候，我们在做一个统计设备的时候，实际上我们把这个地址给它分配好。000001就是放温度、放湿度，这个放压力，这个放流量对吧？这个就是你时间自己规定的对吧？自己规定。但是这个东西它不是一个实际的地址，大家一定要理解。
发言人  
这个是就是说我们后面讲解析代码的时候，就解析这个命令的时候，就是你主机发送也就这个地方。你主机发送这个的时候，我统计是不是要接收，我接收是不是可以解析这个数据，对吧？我接收到功能码之后，我可以解析这个，我看看你这是什么值，你是0002，那我就约定好了0002，我在我这边的话，我提供给你的就是压力。我接收到0003我就代表是流量。
发言人  
所以这个值实际上是一个相当于是一个五，一个一个相当于是一个变量值，对吧？就是相当于是一个变量值。我接收到之后我来判断是零，我就给你温度，是一我就给你湿度，是二我就给你压力，是03我就代表流量。我们只不过在PLC的通讯协议里面，我们说它是叫做一个寄存器的地址。但实际上就是一个数，对吧？我只要判断这个数，我们约定好它是什么值就行了，对吧？
发言人  
你从零开始要两个，我就给你这两个，你从零开始要四个我就给你这四个。比如说我从零开始，你想要四个，对吧？比如说你同学你想要四个数据，你从零开始你想要四个数据，那我就把这四个数据都给你。你看他们把这四个数据都给他了，对不对？所以这个东西大家一定要理解这个概念，对吧？理解这个概念，这个就是03这个功能。
发言人  
那同样的06功能码，06功能码我们讲是写对吧？是写比如说像我们这个，比如说这个压力和流量，我们可以写一个报警值给他。你写一个报警值给他的话，那我就可以用06这个功能码。06的功能码就是写一个寄存器。如果说你写一个寄存器不方便使用。比如说我就想改压力的这个报警值，也想改这个流量的报警值，我可以用什么呢？可以用16就可以写多个寄存器。这个我们再给大家演示一下，比如说我想去设置一个命令或者设置一个数据。
发言人  
那比如说我想设置这个第五个寄存器，我想设置从积的，当然我们这边没有规定对吧？比如说我就想设置这个，我想设置从积的第五个这个寄存器就是我想写它，因为我刚才讲的03功能码是读，对吧？现在是主机想要写这个值，就是我把我的这个值写给你。比如说我这边有一个值，我们主机这个地方我们有一个值是写的那我先把这个改一下，我们要用06这个功能。
发言人  
我们改成06这个写单个寄存器的一个功能。那它它会提示我们它只能写一个对吧？只能写单个寄存器，所以这边地方必须是一。那这个寄存器的我们从哪个地址开始写呢？比如说我从第五个我就只写你这个，我写这个，那这个写的话，这个里面值我写什么呢？比如说我为了区分，比如说我写一个二百。
发言人  
那我们要写的是什么呢？就是写这个地方的这个地方200。你可以看到我们统计这个地方的200就被它给改写了，对吧？就相当于是，我要写一个寄存器，我要写这个。
发言人  
当然了你也改改前面的。比如说我刚才讲了，你要改这个流量的值，我要设置一个流量的一个报警值或者一个什么值给他。那比如说我可以改一下，对吧？比如说我们是这个地方的地址是01234。这个三我们改成200，那这个地方你可以看到我们这个地方就被改写了，对吧？就被改写了。
发言人  
那我们借助这个来看一下这个06这个功能，这个功能码相对来说会比较简单一点，我们可以把这个拷贝出来。写单个寄存器，接着就是06这个功能。这个是写单个寄存器。
发言人  
实际上你也不需要去理解这个寄存器这个概念，实际上就是写写统计数据，对吧？就是向同机写数据。我们03是向是从从积读数据，对吧？就是要求读从积，可以读单个，也可以读多个，就可以读多个数据的那写的话我分成两种形式，一个就是写单个就只能写一个数据，就是让统计写数据，它只能写一个数据。还有可以写多个数据，写多个数据就功能码就变了。这个就是model bus的协议当中规定的对吧？
发言人  
那这个我们写三个的时候怎么写的呢？那你写的话也要主机主动发起通信，那它主页发送通信的时候的格式是什么呢？我大概来看一下，前两个字节都是一样的，都是我们的地址，是功能码。那地址码的话是01对吧？功能码就是06。
发言人  
然后接着接着就是你要写的这个数据对吧？就是你要写的这个地方的寄存器的一个地址，就是寄存器的一个地址。因为它只能写单个GTU，你要给出GTE的地址，接着就是你的数据，最后是CRC。这个大家也要区分一下，地址码同样的是八个比特，然后功能码的话也是八个比特，然后寄存器的地址是16个比特，然后数据也是16位的，CRC也是16位的。
发言人  
这个大家一定要搞清楚对吧？否则的话你后面你在做代码的时候就不好做了，对吧？因为他这个是针对PLC的，我们前面一直讲对吧？大家如果说没有学过PLC的话，我们只是要借鉴这么一个通信协议，所以你要理解它就可以了。
发言人  
这个地方就是寄存器的地址，从哪个寄存器开始？从哪个寄存器开始要写什么数据，这个就是这个那从机怎么应答的呢？我们可以看一下，因为这个地方是主机发送给从机对吧？从机接收之后，从机怎么应答的呢？那这个就是重击。
发言人  
如果说从机正常接收了，那他怎么应答呢？它是主机给他什么，他就回你什么统计应答就是你看它和这个是完全一样的，所以有06这个功能码是比较简单的，就是说主机发什么统计就回什么。如果说从机正常接收，这个是主机发送，对吧？主机发送这是从机应答，就是主机发给我一个从机一个数据了，他要求我干什么？比如说他要写我这个寄存器给我的一个值，那我接收完成之后，我要把这个数据原封不动的返回主机。这个就是06这个功能，这个就比较简单对吧？但是这个它只能操作一个寄存器，也就是它只能改写一个数据，那我要想操作多个寄存器的时候，它就不方便了，对吧？
发言人  
比如说我刚才提到过了，我们去想改写这个2，影响改写3，就是说这两个我都要设置它，我要设置这两个，那你要用06功能码的话，也只能一个一个的设置。比如说我想改这个，我想把这个也改了，我想设置它，那这个时候怎么办呢？那我只能是什么呢？我只能再重新去用06这个功能，改的是地址二对吧？然后地址二的话我改的这个值是什么呢？比如说我改成这个300，那这个时候我们看看统计这边是不是被改成300了，对吧？那就是说我要用00这个功能，那只能改单个寄存器，也只能改一个值。
发言人  
我想改这两个值或者多个寄存器的时候，就要用016这个功能，那就要用这个功能，我们用16写多个寄存器，对吧？写多个寄存器肯定是从哪个地址开始。比如说我想改这四个，我把它都改了，那可不可以呢？当然可以了。比如我改从零开始改四个寄存器，那我们这边改下这边是四个寄存器的那你看这个地方是不是一样的，360、150这个地方我们给它改掉，我们只用这几个。那这个地方你这边一旦发生变化，比如说我用10。20。30。40，我把这四个值要写给你的统计，你可以看到是不是就改过来了，对吧？
发言人  
那这个时候它怎么发命令的呢？那我们可以把它拷贝出来看一下，对吧？这个时候，是我们16这个功能。
发言人  
这个是写多个寄存器。也是向统计写数据。就是写多个数据，这个是向机写单个数据，那这个时候他怎么发的呢？我们这个时候主机。
发言人  
那么可以看一下主机怎么发的对吧？那这个时候首先还是地址码，然后是功能码。有同学说功能码不是16吗？16是10进制，我们16进制就是10，对吧？这个大家也要注意一下，十进制就是10。
发言人  
接着我们可以看到这个地方是什么呢？是寄存器的起始地址。起始地址从第零个寄存器开始写多少个寄存器呢？寄存器的个数四个。
发言人  
寄存器的个数对吧？这个地方是寄存器的个数，我们用红色把它分割一下，然后接着写多少个字节，这个地方是字节数。紧接着字节说后面我们可以看到一个字节、两个字节、三个字节、四个字节。也就是说四个字节的数据字节数，然后是数据。数据乘以济南乘以字节数。那我就直接写数据，那就是N个数据对吧？接着就是CRC。原来的CRC。
发言人  
我们把这个放小一点。这个大家也能够理解对吧？这个就是我们的地址，对吧？这就是我们的地址，这个是功能码。
发言人  
然后接着是寄存器的起始地址。接着就是我们的这个寄存器写的个数，然后接着是字节数，接着是数据，最后是CRC。这就是16这个功能码的一个格式对吧？大家要遵循这个格式？要地址码，就是你要区分需要哪个统计来写功能码就是1616的话16进制就是10对吧？寄存器的起始地址，然后写多少个寄存器，写的字节个数，那他怎么回的呢？我们可以看一下他怎么回的对吧？这个就是他回复的宝贝。
发言人  
他回复他也要遵循格式的，他并不是说任意来回的。他怎么回的呢？我们这边往上给它缩进一个，同样的他回的时候是地址，功能码。然后接着我们看这是地址码，对吧？这个是功能码，然后接着是什么呢？00000004，这个就是寄存器的起始地址，然后是寄存器。
发言人  
起始地址，寄存器的个数。然后是CRC，那它什么意思呢？也就是说主机发送这个数据之后统一接收，也就是我这边来接收了对吧？我接收完成之后，我要告诉主机我已经正常的接收了，那我怎么正常接收呢？我从这个寄存器地址开始，我正常接收了四个寄存器的数据，我接收了四个寄存数据并且处理完成了。这个时候我们会返回主机一个数据对吧？就是返回这个数据实际上就是告诉主机我已经完成了你的发送我的这个设置命令，对吧？因为你要改我的数据，你把这个命令或者这个数据发给我，我接收完成之后，解析完成之后，我再把这个数据返回给主机。
发言人  
主机收到就知道，统计已经正常的接收并且处理了这个数据，那它最新的格式就是用这个。所以这个就是大概的几个功能码的一个用法，对吧？大家可以去适当的理解一下。后面的话，我们再举这个具体的一个应用的例子来理解一下。
发言人  
实际上最好的办法就是你找一个卖的相关的485的这种产品。比如说常见的温湿度传感器，支持485的1个通信的一个model的协议的这么一个传感器。你可以用单片机作为主机，然后去读它的温湿度数据。那你看看他们这个产品当中，它的这个功能码是怎么设置的，它的地址怎么设置的那一般来说可以参考我们这个对吧？比如说一个温湿度传感器，它可能会设置这么两个。当然了它可能其他的功能，它可能还有其他的一些东西，对吧？比如说你还可以去改它的波动率，你可以去改它的地址，那个时候它会放到不同的地址里面，然后它提供的功能码或者其他的功能码，这个大家感兴趣的可以去了解一下。
发言人  
我们希望借助这个工具，大家也可以自己去网上去下载。这两个工具都可以免费的下载到它的试用版。一个是叫做model bus port作为主机来用的，另外一个就是model bus slaver作为从机来用的那这样的话我们可以借助这个来理解一下model bus的这么几个常见的就是这种常见的这种功能，它的一个用法对吧？你看我们这边基本上常见的就这么几个，就那么几个。而且我们一般的话胃的话，我们这边一般都是用这个字节来代替也可以，对吧？我们所以我们常用的就是03、06和16这么几个功能。那剩下几个就是写单个的那就是大家理解一下，你单个的会用的单个这个比特的这种也是一样的。
发言人  
我们大家可以借助这个工具来深入的理解一下model bus通讯协议。同时借助我们刚才讲的这个东西，就是说它的硬件上是借助485来解决数的传输。软件上借助于model 8的协议来解决数据的传输的一个寻址，以及数据的一个传输的一个目的的一个问题。这个还需要注意的就是我们这边列出这么几个详细的几个点。你理解的这几个点，你对model bus的协议的话，可能就会理解的透彻一点，然后你后面再应用model bus的时候，可能就会得心应手一点。我们这节课就先讲这么多。


发言人  
大家好，这节课我们继续介绍RS485通信及model base通信协议。我们为了便于后续课程的一个开展，我们这节课先拿一个实际的一个485的1个model 8的协议的一个具体的一个产品。给大家做一个简单的实验。让大家在上次课的讲解的基础上，进一步的来深入的理解一下模特霸的通信协议。这样的话，也便于我们后续的一些课程的一个讲解。
发言人  
我们后续课程当中，主要分成两个部分。一个就是我们单片机作为主机，另外一方面就是单面机作为从机。那就是说我们在做一个通信系统的时候，或者说开发一个主从系统的时候，我们用单面机的时候，要么单片机可能是作为主机在这个系统当中存在。这样的话，我需要通过单片机作为主机和其他的同机设备之间进行数据的一个交互。我们这节课就是先借助计算机来给大家做一个演示，我们下次课再来用单片机来作为主机来给大家做一个演示。这样的话，我们就基本上掌握了单片机在系统当中作为主机的时候，如何和已经购买的或者说是别人开发的这种基于R1485的model的协议的这种统计设备之间做这个数据的一个交互。
发言人  
那接下来，我们会再给大家介绍我们单片机。如果说在系统当中作为统计设备，也就是说我们如何利用单片机开发一个基于RS485的model bar的协议的这种统计设备，或者这种统计类型的这种产品。我们也会给大家做一个简单的一个介绍。
发言人  
在介绍单片机这个具体的实现之前，我们这节课主要实现两个目的。一个我们先来理解一下如何用串口助手，也就是说来模拟单片机用串口和我们的这种485的这种设备之间进行沟通。那我们先做计算机做一个直观的演示。了解了这个过程之后，我们后面就可以用单片机来仿照我们计算机的串口来发送相关的这种协议真然后去获取相关的微生物数据，或者说去做一些处理，这是一个方面。
发言人  
另外一方面，我们就是要通过我们手头上有的或者说买的别人的这种温湿度传感器也好，或者说是其他的一些设备也好。那先看看别人这个东西是怎么开发他的，他在他的一个手册当中是如何对model bar的协议当中的一些功能码做定义的。他的寄存器地址是如何设置的。
发言人  
我们理解了这个之后，我们自己用单片机作为从积来开发一个这种层级产品或者从机设备的时候，就头脑当中有了一定的思路。那以后开发的时候可能会方便一点，对吧？所以我们这节课主要实现这么两个目的。所以我们先来看一下如何来用单面机，或者说用计算机的串口和这个温湿度传感器之间进行交互。当然了，我们这边手头当中要有一款这种温湿度传感器。当然你没有的话也没有关系，我们可以用上节课给大家介绍的那个工具，来模拟一个这种温湿度传感器也是可以的。这个我们待会儿也会给大家大概的来演示一下。
发言人  
这个它有四根线，那就是说一个是电源对吧？一个就是我们的信号线。这个就比较简单，我们要借助于计算机和它之间进行一个信息的一个交互。也就是说我来先看一下我们如何和它之间进行这个数据通信。比如说我想获取它的温湿度传感器，我应该发送什么样的数据给他？
发言人  
我知道了之后，比如说我以后用这个传感器的时候，我用单片机作为主机的时候，那我单片机这一端我就知道如何操作了，对吧？那我就说可能也就是说用我单片机的串口模拟我的计算机的串口一样去发送这个指令，让他去响应。因为上节课我们也讲过这种主从通信的时候，我们是基于的是主机询问从机应答的一种方式。那我们这边只是用计算机来询问它，你也可以用单片机对吧？我们后面会给大家介绍如何用单片机来问他。他如何给我们回数据，我们回了数据之后如何去解析这个数据，这个大家可以去理解一下。
发言人  
我们首先你需要找到他的手册，那这边正好他的手册我们来看一下。这个手册的话，也就是说如果说你以后做了这种类型的设备或者产品，那你可能也要出具这种类型的手册。那你可以去参考别人的是怎么做的对吧？
发言人  
那他这边是一个R485型的通讯协议，是用的标准的这个mod bus RTO的一个协议。他的操作和回复的命令都是用16进制的一个数据。他设备出厂的时候，设备地址的话是一，默认的波特率是96008个数据位，一个停止位，没有结果校验位。那我们一般设计产品的时候，也基本上是遵循这个规则，对吧？就是说我们出厂的时候，一般的默认的地址都是1，默认的波特率一般会选9600。
发言人  
跟这个是啊基本上是一致的那所以你自己以后开发的时候，我们可能也会按照这个来设置，对吧？另外一个，它会提供它的具体的通讯协议，那一个就是读取数据，它提供了一个功能码就是03。这个我们前期课程当中也介绍过了，03这个功能码主要是读取数据的那可能是读取单个寄存器，或者说读取多个寄存器这个数据他这边会给了一个具体的一个例子。
发言人  
如果说你的设备地址是1，用功能码03从起始地址0000开始读取两个寄存器。那读取这两个寄存器就能够得到什么值呢？那你要看它的具体的寄存器的一个地址的一个定义，对吧？所以它下面会有一个寄存器地址的定义，那我们要学习别人的对吧？别人的寄存器的地址，他这个产品当中一共用到了这么几个地址。所以我们要想以后开发的时候，我们也需要去定义这个寄存器的地址，对吧？
发言人  
那一般的寄存器的地址，我们肯定是从0000开始定义。那我们这边也可以这样子，对吧？00000000这个寄存器地址我们存放的是什么呢？它这边存放的是温度的一个数据，0000000001这个它存放的是湿度的一个数据，那他们俩的数据的范围都是0到65535，并且是只读的。所以它适用于的是03这个功能，对吧？
发言人  
前面这个组态地址大家不用关心的对吧？这个就是PLC当中用的一个组态地址。实际上这个组态地址，是等于什么呢？等于这个寄存器地址加上4001，就是我们这个组态地址。这个要当然了要把它转成十进制去加上4001。因为这个是一个规定，对吧？我们就不再展开了。那下面这些我们不常用，我们就不大家自己去了解一下。我们这节课就是说让大家理解一下人家这个怎么用的。
发言人  
其他的你也可以去增加你的寄存器，对吧？你可以去设置你自己的这个寄存器的地址，来说明你的寄存器里面存放是什么值。那别人读的时候就知道怎么去读了，对吧？比如说我想读的是你当前的波特率，那我可以用03这个功能，从这个0067这个地址起始地址开始读什么呢？读一个寄存器是不是就读的就是你的波特率，所以你这个03有了，比如说我是0103，那这个从什么地方开始读波特率呢？我要从0067这个起始地址读多少个寄存器呢？读一个0001？给一个校验码，那这个时候，它就应该就能够响应什么是你的波特率的数据。
发言人  
同时波特率它也告诉我们了，波特率的话它是可读可写的那既然可读可写，那就它必然还会支持写写的话它应该提供的一个功能码，它提供的应该是06这个功能码。我们上节课也讲过，06这个功能码，就可以写单个寄存器，吧？写单个寄存器，那你也可以用06这个功能码去对它进行操作。比如说去更改它的设备地址，去修改它的波特率，那这个都是可以？那我们这个就不再具体的去挨个的去看了。接下来我们就来参考这个来做一个实验？
发言人  
做一个实验。那它既然的话，它的这个默认的地址是1对吧？默认地址是1，那我们来读它的话，怎么读呢？我们这边给大家做一个演示。我们这边正好有一个温湿度传感器，但是我们知道我们计算机这边是USB接口，这个是485信号，它们俩之间是肯定不能直接通信的那怎么办呢？我们可以借助这么一个小模块，这个模块是一个USB转485的1个模块。这个模块现在也不贵，对吧？大家感兴趣的也可以手头上去入手一个。我们可以看到这里面有四根线，那就是电源线，还有两根信号线，然后I线接这个传感器的AB接这个传感器的B那这个电路就连好了对吧？那这个连好了之后，我们就可以借助我们的这个助手来实现这个通信的功能的一个测试，吧？
发言人  
那比如说我们给它发一个问询帧，我们知道它支持的是主机问询从机应答的一种方式。所以你主机要去问他他才会给你回答数据。我们上节课也讲过了，在这种主从系统当中，我们的同机设备是不允许主动的发起通信的。我们要想通信必须由主机发起。那我们可以去打开这个串口，我们去发送我们的问询针。01030000，是0002。我们读两个字节，从0000这个寄存器地址起始地址开始读读两个字节会读的是什么值呢？就是我们刚才这边已经介绍到了，读这个寄存器，再读这个寄存器，也就是把温度和湿度都读出来。
发言人  
我们来看一下，这个时候还有一个校验码对吧？那校验的话是CRC校验，它这边是用的319F。319F那我们可以发送，地址写错了，对吧，应该是用上面这个，是校验码，是C40B。你校验了不对，它是肯定是不会响应的对吧？
发言人  
这个时候它给出了一个响应，这个时候我们看他给出的值是什么呢？是0103，然后04。那就是说01代表什么意思呢？代表01地址，03的功能码，04就代表返回的数据长度四个字节，对吧？给出的值，我们这边返回的值是什么呢？我们可以看一下是048915B2。
发言人  
他这边举了个例子告诉我们了，它这里面的数据的值都是16进制的那这个16进制值代表什么含义呢？它首先要把它转成十进制数。这边举个例子，比如说0079，它转成十进制是121。那假设数据的倍率是100倍，那这个值应该是1.21度，对吧？那这个也是一样的，湿度也是一样的。所以它这个地方有一个倍率是100，那你要看它这个设置对吧？那我们这边就可以这样子来处理。
发言人  
那我们看看当前的温度是多少？那我们可以去计算一下对吧？那就这个是温度，后面这个是湿度，这个是16进制的489。489的话我们可以用这个计算器打开一个，我们是489，那当前转成十进制就是11度左右。那当前温度，我这个房间温度在11度左右，然后看湿度，湿度的话它是15B2，1512，湿度的话是55.54%。
发言人  
它这里面有一个100倍的一个倍率在里面。那这个时候我们就知道了，对吧？那我们就知道它的温度是多少，湿度是多少。
发言人  
如果说我是用单面机来处理应该怎么办呢？那我用单面机应该也是发这个问询针。当我需要采集温湿度传感器数据的时候，我用单片机发这个问询针，等待接收对吧？那我们应该怎么做呢？那就是说我们上节课讲了，单片机首先要切换成发送状态，对吧？因为我们要控制一个485的1个接口芯片。首先转成发送状态，转成发送状态之后，然后发送这个问询真发送微形针之后，立马切换成接收状态，接收这么一帧数据，用超时的办法去接收。
发言人  
接收完这么一包数据之后，我要解析这个数据。那怎么解析呢？那就是说我要把这两个数据取出来，对吧？把这两个数据取出来之后转成十进制，按照它这个数据的方式把它再除以100，就可以转成当前的温度和湿度，对吧？那这个就是我们用单面积来处理的一个办法，大家感兴趣的可以去了解一下对吧？
发言人  
当然了你想去修改它的设备地址，你也可以用我们后面的指令去修改。比如说你要想改地址，你可以用0106这个功能去修改它。比如说我想改成02，那我就会去按照他这个方式来去修改一下。比如说我这个产品，比如说我做了一个组成，需要用两个点的温湿度传感器，那这个时候我就要用两个的对吧？有两个的话，那我不可能让他两个都是用同一个地址。所以我要改我买了一个产品，它默认的是01，那我要把它的地址改成02，那怎么改呢？我们就用这个功能，就是06这个功能码。
发言人  
06这个功能，我们前面提到过，它是写对吧？那是写单个寄存器，那01我们可以是06，你要更改这个设备地址，那设备地址寄存器地址是多少呢？那你要看前面，吧，设备地址的寄存器地址是0066。所以我们要是0066，那0066有了之后，我们接下来要改地址。你要改的地址你要给他个数据对吧？那你给个数据，比如说你要改成02，那就是0002。然后最后是我们的这个校验E8，然后是14。然后这个时候，我给他发这个指令，他应该就会把这个地址改成02。
发言人  
那我们点击发送，但对于正确的一个命令帧它会响应，对吧？它响应给我们数据是什么呢？那就是人家手册当中也指出来了，对吧？它会响应什么呢？它会响应你修改后的设备地址02，你的功能码06，接着是寄存器地址0066，然后目标地址你修改的这个目标地址0002，这个时候你就修改好了，对吧？
发言人  
那接下来，如果说你还用原来的这个地址去读它，那你肯定就读不出来了，那怎么办呢？比如说你可以试一下，我们再用0103。用0000，0002，是我们的C4，0B这个时候你再去读它的时候。那它就没有响应对吧？它就没有响应，那我点一下就没有响应，那原因是什么呢？原因这个设备它的地址已经不符了，对吧？
发言人  
你发给他01的时候，他的设备地址是02，他第一次比较这个地址的时候，他就知道不是发给他的。所以他后面的数据他是不会去解析处理的，他就不会给你返回数据，对吧？他只有对于正确的应询问寻真，它才会给出响应。
发言人  
那有同学我们要用02，那02的话你要改后面这个对吧？那你要注意一下，你的这个CRC校验也要正确对吧？那你的02功能码03，连着读两个寄存器，从0000这个寄存器开始读，还是读的温度和湿度。
发言人  
这个地址的话，我们对于这个微型针，它的校验码是多少呢？我们可以前面介绍过一个工具对吧？可以用这个来计算一下。我们计算这个是C4是38C4对吧？是38C4，那这个时候我们就可以去试一下，对吧？
发言人  
那你可以去试一下，我们是38C4，我们这个时候是。我们来发送。这个时候它又给出了我们的具体的一个响应对吧？给出了数据我们可以看一下，那还是这个？这是具体的温度，这个是湿度，这个是我们的地址？功能码，然后返回字节数，后面是校验。这个时候我们就得到了我们的温度和湿度的一个数据？
发言人  
那这个时候每次都要计算这个校验码，不太方便？那我们这个时候要想调试model base这个产品，我们可以用我们上次课给大家介绍了两个工具，一个就是这个mode bus泡，另外一个就是mode bus这个slaver。你的手头上如果说有同学说我手头上没有这个卫视的传感器，也没有这个USB转485的这么一个一个设备，或者这么一个小的一个转换器，那我怎么办呢？你可以用这个东西来模拟，你可以用这个作为再模拟一下也是可以的。
发言人  
待会儿的话我给大家演示。我首先演示的话，我们用它作为主机如何去读取微湿度传感器的数据。这个就很简单了对吧？那我们首先把这边的串口先给它关掉，我们这个地方去先连接一下，打开串口，那就是com 5，9600波特率八位数，九位没有机构校验，然后一个停止位点击OK然后的话，我们要设置一下，我们这边的话，要读的话，你要读这个温湿度传感器。但是我们的设备地址我们知道是二，对吧，设备地址2，然后从寄存器，是从00开始读寄存器，就是零读两个寄存器。我们点击OK那这个时候你看它就把温湿度传感器读过来了。它读过来之后，并且这个地方显示的时候，你可以看到它已经把它转成了十进制来显示了。所以我们很容易就清楚当前是11.6度，是56.42%，这个是相对湿度。
发言人  
当然了你可以看它具体的这个数据，我们看一下它具体的发的数据是什么呢？那这个时候我们可以看到，我们先把它停止，然后把这个数据拷贝出来。宝贝，我们把它放在这儿。你可以对照一下，对吧？那这个是接收的返回的，我们把发送的拷贝出来。
发言人  
这个是不是和这个是一样的，对吧？然后它返回的。
发言人  
你可以看到返回的值对吧？实际上也是一样的？那就是说我们借助这个工具就很方便，就不再需要单独的去找一个网站去计算这个CRC校验码了，对吧？那我们就可以借助这个来实现我们的相关的操作。
发言人  
当然了，你也可以用它来实现修改你的这个地址，对吧？比如说我们可以借助它来修改地址，你看它一般就提供两个功能，对吧？因为它也没有提供。
发言人  
我们前面上节课也提到过，我们可以用另外一个功能码对吧，可以去读写多个寄存器。这个地方有个功能码叫做这个16对吧？可以去读写多个寄存器，就是写多个寄存器。它这边实际上就提供两个功能码，一个是03，一个就是这个06，对吧？一个是因为我们对这个产品来说，对一个统计设备来说，要么就是说可以去读它的数据，它返回数据给我们。要么就是我去修改它的一些设置或者一些参数，所以这两个功能一般的产品来说基本上都是足够了，对吧？那大家可以去理解一下对吧。
发言人  
那我们这边，比如说去修改这个地址，你可以去试一下对吧？那修改地址的话，我们是用的这个二吧，这个地方因为我们当前已经改成二了，功能码的话是用06，我们把它改成一，我还把它改成一对吧。但是你需要注意的，我改的时候，你这个地方设备地址，设备地址的话，你要看他这个手册当中刚才提到了对吧？
发言人  
修改设备地址的这个地址是0066。但是你要注意它这个地方的66，它是十六进制的一个66。我们这个地方，是用的十进制，它这个软件当中都是十进制，所以，你还要把这个六六，转成这个十进制。那这个六六，就是102。这个地方如果说你用这个软件来操作，那你这个地方，它的起始地址是102，这个大家要注意一下，是102，然后点击OK，102的话，你还要注意一下102这个地方，我们的设备地址是改成一，给它改成一。
发言人  
那这个时候，有同学说这个地方是不是没有正常响应，他说tim out error，实际上不是，是因为他发的太快了，这边他在一直在发，他已经应该已经修改过了，对吧？那如何去验证呢？我们可以去这样子来验证一下。比如说我再来读一次不就知道了吗？实际上就是说如果说我们刚才我们这样子，如果说我们刚才演示的时候把这个地方给它打开，你可能就能够看到它那个响应的一个数据了。只不过刚才我们是他发的太快了，发完之后他再发的时候，你想一想他现在你的设备地址已经被改过了，对吧？但是你现在这个地址，你现在这个地址用的是2，但实际上你已经把它改成一了。所以它再出发，它全部都是响应是错误的。
发言人  
我们可以用一来试一下，从零开始，然后用03这个功能码，我们读两个寄存器地址，再点击这个OK那你可以看到这个时候就把数据读出来了，那就说明我们修改是成功的对吧？是修改是成功的。所以大家如果说用这个工具，你也可以去去单次触发它。如果说用这个工具想单次触发的话，我们这边有一个设置，可以把这个给它勾上，就是说我让他disable。那这个时候我想让他去发送命令的时候，我不让它自动去发了，我就点这个，我点一次它才会发一次，我点一次他发一次，这样的话就更便于调试，否则的话他会一直来发，对吧？当然了你也可以设置这个时间，这个就是给大家的一个调试工具。
发言人  
有同学说我手头上没有这个温湿度传感器，那我怎么调试呢？你可以开发的时候，我们一般来说，刚开始我可能也不去接这个温湿度传感器，我可以先用这个软件来模拟这个从积模拟这个统计的话，你就可以来读了，对吧？比如说我们这个地方，可以把它设置一下，比如说我就设置成一对吧？设置成一，然后的话我作为从机的话你需要是功能码是0，对吧？功能码是0，需要读多少个寄存器呢？比如说我们这边就用两个寄存器，那这个时候你就提供了两个寄存器。
发言人  
比如说你把这个值改一下，这个值的话，比如说我当前是这个11度，比如说我就用这个1163代表的11.63度，然后这个我就代表的是53.2553。比如说二三代表的是53.23%这么一个相对湿度，那我就可以用主机来读它了，对吧？那我主机来读它，那我怎么读呢？那这个时候只能用虚拟串口，我可以做一个虚拟串口。当然了如果说你是有这个硬件的话，你就不需要这样来操作是吧？
发言人  
那我这边就借助于科目三到科目二，在这个地方我来设置一下。我在这边的主机，我们也更改一下，对吧？我把它改成我们的这个科目二的科目三。然后的话我们再来设置一下，用这个寄存器然后来读，我们来让他读一次。那这个时候1163，你这边的值是什么呢？是不是1163，5523对吧？那这个时候我们也可以用这个来演示，就是说就是这个工具，大家就可以很容易的理解这个功能码和它发送数据和返回数据的一个情况。吧？
发言人  
比如说我们这边让他去运行一次对吧，你在这边的统计这边，实际上也是可以监控的到的，统计也是可以监控到的那我们统计这个地方也可以监控得到，于是我们这边再运行一次，同济这边也收到了对吧？同济这边也收到了。所以大家可以借助这个工具，很方便的来学习这个mode bars。同时我们借助这么一个产品的一个演示，那我们就很容易理解了对吧？别人在设计产品的时候，一般来说设置的功能码一个是03，就用来读取数据。
发言人  
读取数据的时候，我们用户在设计的产品的时候应该怎么设计呢？那你首先要设计这个03功能码它针对哪些寄存器？那这个寄存器它到底什么含义呢？实际上就是一个你说是寄存器地址，但实际上就是我们给它一个变量，对吧？如果说我们用C语言来编代码，那实际上就是说我我在我默认的我认为我接收到这个数据的时候，就是说你要获取的是温度的一个计算机的数据。就是这样。实际上是我们人为的一个定义，对吧？它不是一个实际的一个地址，这个大家要理解一下对吧？
发言人  
理解一下就是它不是一个实际的地址，就是我们一个规定。比如说你发送命令的时候，你发送这个0103，我接收到工程码，我接收到你的0000，我就知道你要读多少个寄存器。你要读一个，那我就认为你是在读温度，这个是我们在设计产品的时候自己设计的，自己规定好了对吧？那这些地址也是我们自己规定好的。
发言人  
当然了你要参考的这个model bard协议？那这样的话，我们就把这个东西规定好，给出了一般的功能码，一个是03对吧？一个就是06。这个03和06这2个功能码都不是特别难。这两个功能码你理解了以后，你再去扩展其他的功能码可能就更方便一点。比如说03这个那就是一个地址，一个功能码，起始寄存器的地址，寄存器的长度，校验码，那这个就是他的。
发言人  
对于这种问询真他要给出响应，就是你设计产品别人发给你这个，那你接收是不是要解析，对吧？你接收01，知道是我的我再继续解析，知道是03，它是要读了，找到他要读什么呢？那你判断他是0000，那我就知道他要从这个地址开始读。那他要读多少个呢？他要读两个呢？我就知道他要温度和湿度。那我设计的当前那个温湿度产品，我应该怎么办呢？那我应该给他回一串数据，怎么回呢？
发言人  
我这边比如说你是用单片机开发的那你可能单片机你有一个温湿度，有一个传感器，有个单片机，还有一个max 485这么一个接口芯片。那你首先，你的单片机这个时候，你要采集温湿度对吧？采集了温湿度之后，你要把它组合数据包。组成这个数据包之后，然后把这个问询针给它拉回去？那这个就是我们要从这个产品的角度去理解人家这个东西是怎么设置的。包括他们的这个波特率，包括他的协议类型，包括这些东西。
发言人  
那以后你设计的时候，你也可以参考他这个来设计你的寄存器地址，然后来设计你需要干什么事情，需要干什么事情，你的数据范围，你的数据类型支持哪些这个功能。这个大家感兴趣的可以去多了解一下。比如说这个东西我们熟悉了之后，我们下次课就可以给大家讲述我们如何用单片机来实现读取这个传感器的温湿度数据。那这样的话就很方便了，对吧？那比如说我构建了一个主从系统，需要用到多个温湿度传感器。那我用单面机就可以发这个问询帧来得到我们的温湿度数据。把这个温度数据解析一下，去做显示，或者去做其他的一些控制处理等等。这个，大家感兴趣的可以去了解一下。给大家讲这个的目的，主要是让大家更加的巩固一下我们这个mod bus协议。也就是说深入的理解一下，你只有理解了这个协议，那你后面自己在做应用的时候才知道如何去入手。

发言人  
大家好，这节课我们继续介绍RS485通信及mool bx通信协议。这节课我们以单片机为主机，读取基于RX485 model base协议的温湿度传感器数据，并把它显示在一个OLED屏上。这个温湿度传感器上次课我们给大家介绍过了，只不过我们上次课操作是针对的是这个计算机。我们用计算机通过USB转485的1个模块，然后连接到我们这个传感器上，读取它的温湿度数据。并且通过这个我们了解了这个传感器它的一个model bar的协议的一个设置。从而我们熟悉的model base协议当中的两个功能码，一个就是03功能码，一个是06功能码。这节课我们就以单片机为主机，来读取这个温湿度传感器的数据。我们来看看这种方式我们应该如何来完成这个开发。
发言人  
上节课我们实际上已经设置了这个传感器，对吧？我们把这个地址，我前期已经把这个地址改成了03这么一个地址。我们通过这个软件，我可以给大家看一下，我们这边做了一个硬件连接。
发言人  
这个上节课我们已经讲过了。那就是说我现在是把这个传感器通过了一个模块，就是一个485USB转485的1个模块，连到了这个电脑上。我通过电脑来读取它的温湿度传感器的数据。我们先测试一下，我们再用这个单片机。这个是我们以前做了一块工控的板子，这个板子当中正好带了485接口。
发言人  
我就以这个板子为例，来给大家演示如何把这个温湿度传感器的数据读出来，并且显示在这么一个小的OLED屏上。这个只是一个测试的一个板子，因为我们手头上没有这种现成的开发板。接下来我们来演示一下，先用计算机再给大家看一下。计算机的话我们前期我已经把它连好了，那我这边的话485的接口是com 13，那我把它OK，我这边要设置一下，我要读取它。
发言人  
现在的话这个温湿度传感器，就是我们这个温湿度传感器的地址，我已经把它改成了这个03。所以它的地址是3，我们用功能码03，读取从地址零开始读取。这个我们前期上次课的话也介绍过了，它的一个地址是从0000开始。这前两个寄存器的地址是温度和湿度，所以我们设置的时候，就是从零地址开始读读两个寄存器，然后点击OK，我点击这个地方去读一次。那这个时候，就把这个数据读出来了。那这个时候，我们就得到了我们的这个呃读数据和它返回数据的一个格式。
发言人  
那我们来看一下这个格式，我们再来读一遍，我们把这个数据先考出来，这样的话方便我们待会儿的话用单片机编写代码。我们把这个拷出来拷贝，我们把它拷贝到一个文档里面来，这个是发送的数据。然后为了方便我们待会儿来解析这个代码，我们把他的接收的也拷过来，这样的话我们方便待会的话去解析。
发言人  
这个就是传感器回复的一个数据，我们把前面这个序号给它删掉。那也就是说我要想读取这个温湿度传感器的数据。那一般来说我们用这个模块的话，我们一般用这个模传感器的话，那我们肯定就是为了温湿度传感器的数据。我一开始的话可以通过计算机的串口把它的地址以及它的波特率都给它修改好。然后我在单片机编程用的时候，我只需要用这个03功能码来读取这个温湿度传感器就行了对吧？我这个时候就需要发的是这个协议命令？或者这个寻指针，那就是这个0303000、00002CEC5E9。它会返回我们的温湿度数据。
发言人  
返回数据之后，我们肯定是要解析的。我用单片机要去解析对吧？我要知道他回了几个字节，然后这个字节代表了什么含义，这个字节代表什么含义？我们通过它的这个手册当中的也可以看出来，它是以16进制来表示的。他要把这个数据转成十进制之后，然后再除以100就代表它的一个真实值。那这会儿的话，我们在程序当中也会这样子来处理。
发言人  
接下来我们就来看单面机这一块应该如何来编写。单面机这边我们这边刚才已经提到过了，我们用了这么一块板子。这个是我们前期做的一个小项目当中用到的一块工控板。这个板子当中有一个STC的单片机，有一个OIED屏，然后这个地方有一个485的1个芯片，正好这边有个485的接口，那我们待会儿的话，就借助这个485的接口来读取这个温湿度传感器，也就是我们这个温湿度传感器的数据，把它显示在这个屏上。
发言人  
那这个整个的开发过程应该是什么样子的呢？是不是我们一开始就需要把这个温湿度传感器挂在这个板子上来完成这个程序的开发呢？实际上我们在开发的过程当中一般也不是的。我一开始的话肯定是要把程序大概的调通，然后再去挂这个温传感器。那这节课我们就来展现这么一个整个的一个开发过程。
发言人  
当然了，不同人的开发过程可能也不一样的。我这边的话习惯于先用串口，就是说用计算机的串口来做仿真调试。仿真调试通过之后，我们再去挂硬件。这样的话我就能够判断到底是哪边出现了问题。那我们看一下这个应该如何来开发？当然前期要做一点准备，那就是说为了完成我们这节课的测试，又为了这个时间上不会特别长，我们这节课重点展现的就是关于温湿度传感器的读取。
发言人  
也就是model的协议的一个我们的指令发送，也就是主机发送这个mode bar指令，以及接收到指令之后的一个解析。所以需要前期我们的一些代码的积累。实际上前期这些代码的积累，我们前期课程当中全部都陆陆续续的介绍过。那我们主要是从哪些地方来找呢？
发言人  
第一个是串口，我们这节课既然要用到串口，对吧？那这个串口我们是用到串口一这个串口的代码的话，我们前期重点介绍过，就是用超时来接收我们的这个串口的一个数据。这个代码我们前期是介绍过的，待会儿的话我们会简单的回顾一下。因为既然用了超时，所以我们用的定时器和这个串口的一个结合，实现了一个超时接收。这个我们前期课程当中也是介绍过的，大家感兴趣的可以参考我们以前的视频。
发言人  
除了这个之外，我们还需要用到OIED显示。这个OIED的话，我们前面也单独讲过如何去做移植。需要用到这么两个文件，一个是底层的R平方C的，我这边的显示屏是R平方C总线的一个显示屏。还需要这么一个一个接口的，就是关于ORED操作一个接口的一个文件。这两个也是我们前面介绍过的那这个是一个关于把这个整数转成一个字符的一个函数。这个我们在前期课程当中也是介绍过的，大家感兴趣的可以去找一下。我们前期在介绍这个应该是在18B20读取温度，然后转成到液晶屏当中显示的时候，应该也介绍过这么一个函数，就是实现如何把一个整型数转成一个字符串数组，这样的话便于我们待会儿去做显示，这个也是前面介绍过的。
发言人  
另外还有一个CRC，CRC的这个，我们前期课程当中也提到过，这个可以去网上直接去下载我们在model s当中用的这个CRC的校验算法，网上有开源的代码，大家直接把它拿过来来用。主要注意这个函数接口，我们主要用这个函数接口。至于它内部的实现的一个原理以及它的方法，感兴趣的可以去查找相关的文献资料去看一下。我们主要用到这个函数的接口就可以了，对吧？那这个时候，我们这边基本上这种源代码就是前期课程当中全部都是介绍过的。我们把它拿过来，我们来看一下如何完成本节课的一个测试。
发言人  
既然我们要做一个温湿度的，所以我这边一开始定义了两个变量。一个是温度，我给它一个初值，另外一个是湿度，给它一个初值。这个两个就是温湿度的一个数据。我们待会儿的话就要通过温湿度传感器读出来的数据，付给这两个变量，然后便于我们去做处理。
发言人  
在我们在读取温湿度传感器数据之前，我们首先要解决的问题，第一个就是把串口测试通过，对吧？另外一个，我要把这个显示测试通过。我们前面也提到过，有显示的，我们先把显示调通。有串口的话，我们先把串口调通，就先把基础的功能调通，然后再去做我们应用层的一些代码。这个大家要分层去调试，否则的话大家总想着把所有的代码一次性写好，那也是不太可能的对吧？所以我们的程序一定是调试出来的，就是在你前期代码积累的基础上来调试代码，快速的完成开发。我们接下来，首先把串口来调通，我们再来给大家看一下这个显示，显示这边我也不带着大家挨个的敲了。因为这个代码前期我们在介绍OID屏的时候，实际上都介绍过了。
发言人  
我们这边的话给大家大概的来看一下，我们最终的目的就是要把温湿度数据显示在这个OIED屏上。我这边提前显示的一个温度和湿度的值在OED屏上，这个温度和湿度的值就是我们这边对应的这两个变量。现在是显示的一个默认值，对吧？当我们去后面操作了温湿度传感器读过来值之后，那这两个值肯定会发生变化。从而我们显示屏上的这两个值也会跟着变化。所以我们把显示调通并不仅仅是只能显示一些字符，而是把我们这个温湿度数据就一并把它显示出来了。只不过我们要做好接口，这两个变量就用来显示温湿度的。只不过我们后面用温湿度传感器读过来的会传给这两个变量。
发言人  
从而我们这个一旦调通了，接下来我们要做的重点的一个任务就是调温室度传感器显示就不用再操心了，我们一次性先把显示调通。这个显示调控的过程非常简单。我们知道我们这个温湿度传感器温度的话有可能是小数，那湿度的话是没有小数的。所以我们在程序处理的时候要先判断一下它是不是小数，如果是小数的话，我们应该如何去显示？或者是整数的话，我们应该如何去显示这个大家感兴趣的可以去看一下对吧。那我这边的话如果说小于0，也就是这个T小于零的时候，这边是传输的这个是温度，这个是湿度，对吧？当这个值小于零的时候，我们显示的时候会这样子来显示。那当然了，你可以再给它增加一个负号，对吧？增加一个负号我们这个就不介绍了。
发言人  
那接下来就是说整数的时候，我们就是这样子来显示。首先是显示这个temple这么一个固定的一个值，把这个数据显示在后面，这个数据是显示的什么呢？要把它转成这个字符串，我们把这个整数值转成字符串，再去显示这个字符串就可以了，因为调用的是show string这么一个函数，当然了你也可以调用。我们这个接口当中应该也提供了一个show number的一个函数。但是那个大家需要自己去写。我们这边要转成字符串，就不需要单独去写，只需要把它转成字符串就可以了。那这个时候，我们就可以去完成了一个显示的一个过功能。这个大家可以自己参考着去把这个去把它调通。我们先把这个代码下进来，看一下这个显示能不能正常进行。
发言人  
我们这边是串口14。
发言人  
那这个时候我们可以看到，我们这个时候显示屏就已经可以正常显示了，显示的就是这个25和35，显示的一个是温度，一个是湿度，这个时候我们就把它做好了，对吧？那显示调通了之后，我们接下来就来把串口来调通。那串口如何调呢？串口的话前期代码初始化的代码我们已经前面已经介绍过了，我们再来回顾一下。那这边的话主要是9600的波特率，115200的一个晶振。这个情况下我们是用的我们这个工具，直接生成了一个初始化的代码。这个感兴趣的可以参考我们前期的视频，这个地方有一个波特率计算器，我们可以生成一个代码，就生成我们的9600的波特率是1.059，这个精准。
发言人  
然后主要注意这边选模式的时候，我们普通的51单片机，它只有八位的自动重载的一个方式。这个地方你可以选择12T的时钟，或者是一T的都可以。要看你这个具体的单片机是12T的单片机还是一T的单片机。这个选好之后生成代码，我们把它拷贝到这儿，这个时候就完成了这个初始化的一个工作。当然了，这个地方我们注意要把这个中断给它打开，电流器的一个中断给它打开，这个地方就打开中断，对吧？打开中断这个地方完成之后，我们接着就完成是串口发送数据。
发言人  
串口发送数据这个前期课程当中我们也介绍过，就是把一个数据放到这个SBOF当中，就等待发送完成。接着有了这个函数，我们就可以完成发送一个字符数组，或者说一个硕主发送一个数组的一个函数。那这个数组当中就调用这个函数就可以了。
发言人  
接着就是我们中断服务函数，中断服务函数当中，我们主要完成的是超时接收。前期我们分析过原理，超时接收就是每接收到一个新字节，我们会启动一个软件定时器，用这个软件定时器去启动定时。在启动定时的里面我们干什么事呢？我们会把一个变量会加加，也就是这个变量我们会做一个累积的一个计数器。这个累积的计数器，一旦这个定时器打开，它就会在这个里面进行加1，它就在这里面进行加1。
发言人  
但是我们在串口中断里面每接收到一个字节，你可以看到我们在这个串口中断里面每接收到一个字节，我都会把它清零。所以如果说你这一包数据没有结束之前，它这个是一直为零的对吧？你每接触一个新的字节它就变成零了，每接收一个字节它就变成零了当你发送完一包数据之后，那你再等了很长时间才会发第二包数据，对吧？当你发完第一包数据，那这个就没有新的数据来了。没有新的数据来，这个值就不会再加就会变，就不会再是零了。
发言人  
因为在这个里面没有新的数据，这个里面的话这个值会一直加加，对吧？当它加到一定的时间范围的时候，我们可以设定一个最大的一个时间范围。我们认为是超时。我们就认为这一包数据接收完了，我们给一个标志位代表的是这一包数据接收完成。那这个时候，我们根据这个就可以知道我们是不是接收完了一包数据。这个也就是上节课我们给大家讲的mode bar的协议当中，它实际上是靠时间间隔来实现我们的报文和报文之间，或者是数据包和数据包之间的一个区分的。所以大家要学会这个超时接收的一个办法。
发言人  
这个超时接收并不是特别难，对吧？只要你理解了原理，那你自己也能够去完成。我们接收的数据保存到一个缓冲区当中，并且给了一个我们的一个索引。这样的话我们后面接收的数据就会存在这个数据缓冲区当中。那接收多少个字节？就由这个索引来决定的。这个计数器主要是为了做超时的，就是说每接收新的字节会把它清零。
发言人  
当你没有新的数据过来的时候，比如说你发送了一包数据，像我们刚才发的这个，比如说0103比如说我们是地址是03，是功能码也是03，然后是00就是起始地址，起始寄存器地址0000，然后读两个寄存器02，然后后面跟一个CRC校验。当你发这一包数据的时候，那我们这个抗压感器，它应该会传感器要应答，对吧？传感器会应答，它应答的数据是什么呢？就是我们刚才已经看到的这一串数据，比如说当前的温度、湿度是这个，那它会应答这一串数据。那他就拿这个，那我们把这个也补充完整。
发言人  
他应答的就是这个数据对吧？那传感器应答这个数据，我们在接收这个数据的时候，怎么样来区分这一包数据和下一包数据呢？那就是靠时间？当你发完这一包数据发到这个的时候，就说你每发这么一个，每接收到一个字节，我们这个值就会在中断里面清0。每接收一个它就清零，所以它这个值是长不大的。
发言人  
当你发送到最后这个字节之后，要隔一段时间才去发下一个手机包，对吧？比如说你又发了一个手机包，那下一个数据包里面这个值温湿度的值肯定会发生一点变化，对吧？会发生一点变化，那这个值就是另外一包数据。但这个地方的时间间隔是不是很长的一个时间间隔，那这个时候在这个之后没有紧接着一个数据来。所以这个值在我们的定時切入器这个里面就会累加，它会加就会加上很大对吧？
发言人  
超过了一定时间范围，我们就认为接收了一个这包数据接收完了，这个就是超时接收的一个方式对吧？那这个超时接收我们前面也介绍过，如果说还不能具体的理解，可以去看前期的视频对吧？那这个时候串口我们就调好了。有同学说那你485波士还要控制方向，我们先不着急，我们先把这个串口调通，我们再去调整这个方向，再来控制这个方向。
发言人  
我们先把串口调通，因为在我们的485是在我们的异步串口通信的基础上来完成的那这个串口的话大家感兴趣的可以去了解一下。那接下来，我们在主存当中把它来测试通过。那怎么测试呢？我们在串口当中后面还写了一个函数，就是我们重写了一个polo叉函数，就为了实现prot f那方便我们代码调试的。当我们调试完了，我们可以把它注释掉。
发言人  
那我们怎么调试呢？我们先把串口看看能不能调通，那调控的话我们可以这样子。首先的话我们先发送一个测试的。
发言人  
比如说我们这边就叫RS485。然后是model bus test。我们先看看这个能不能正常的输出，对吧？我们先把它编一下。让他下载。下载完成之后，我们打开串口。这个时候我们先用文本模式，我们打开串口。这个时候要注意，我们这边是com 14，打开窗口之后，我使单片机复位。那这个时候能够正常输出，那就是说我输出功能是应该问题不大了。
发言人  
那接下来下来怎么办呢？我们做温湿度做的时候，我们一般的话是做定时采集，对吧？所以我可以做一个定时发送命令帧，让传感器来应答的一个方式。然后怎么做定时呢？我们这边正好有一个软件定时器，那我就在这个里面做一个，因为我们这边对时间要求并不是特别的高，所以我们在这个地方直接做一个处理就行了。那我这边就利用这个硬件定时器，再增加一个定时的一个功能。
发言人  
比如说我这边定一个。我定一个一个接收器。我定一个计数器，我用这个计数器来做一个时间的一个累积。我们这边定时的时候，当时是做了一毫秒。比如说我想这个大概是2秒钟或者是3秒钟去读取一次微速度传感器的数据。当然了，一般来说温湿度传感器数据，你的读的时间间隔可以放的长一点，对吧？因为它一般的场合我们在用的时候它不会突变，所以我们可以几分钟读一次都是没有问题的那我们这边为了测试，我们就大概两秒钟读一次，给大家看一下如何来做就行了。对吧？
发言人  
那我们这个地方怎么做呢？我们把它放到后面，就先保证我们这个，再做下面的那怎么办呢？我们把这个值给它做一个累加，这个地方注意我们在如果说定义在这个里面，我们把它定义成静态的。否则的话你一秒一毫秒进来之后，它就会变成零了，对吧？我们要把它定义成静态的，这样的话这个值会一直占内存。当我们一毫秒进来之后，只有第一次的时候会给它赋一个初值，其他时候是用它后面的值。这个大家一定要注意，它加加然后它加加之后，如果说这个值。我们把它大于等于，我们是一千，大于等于1000的时候就大概是一秒钟的时间到，对吧？
发言人  
那我们可以定一个一秒，把这个秒给它这个1，那我们现在想实现的是2秒钟，那我就直接是给个2。这样的话就把这个秒的一个flag，我们把它这个腰同时我们注意一下，我们还需要把这个计数器给它清0，方便于产生下一次的这个时间，对吧？当然了，你自己的话可以根据你自己的时间去做处理，对吧？来看看你用多长时间。那这边我们注意一下是2秒钟。2秒钟的一个标志位，2秒钟。这个你要定一个全局变量，我们在这个地方定义成一个全局变量。
发言人  
可以给他一个初值。全局变量的话，我们需要在这个文件当中给它做一个声明，那我们就把它写在这个位置。我们定义成外部的，这样的话方便我们在其他文件当中能够使用它。那这个flag我们就有了，对吧？我们在这个主程序当中，main函数当中，V函数当中，我们已经包含了这个头文件。我们在这个文件当中，把所有的头文件都放在这个里面了。这个里面包含了所有的头文件，那我们这个地方就可以这样子来做了，对吧？那我们就来判断一下，如果说这个标志为幺了。
发言人  
这个标志为1了之后，我们要读取微生物传感器的数据。那我就要借助串口去发送我们的这个我们的寻址针对吧？或者说我们的报文，或者我们的这个数据包。那发送的数据包是什么呢？就是我们这个数据包对吧？因为这个传感器的你的这个地址已经确定了。
发言人  
我们已经前期通过这个计算机的串口把它修改过了，修改成03了。比如说接下来功能码，我们就用03这个，就租这两个寄存器，因为我就需要知道的就是温度和湿度，那我们就可以用这个数据包，那我们怎么发送呢？我们可以这样子来做对吧？我们这样子来做，那我就先来测试，待会儿的话我们再把它去做封装。那这个时候我先把它写在这个地方，待会儿的话我们再来改代码，我先定义成一个数组。
发言人  
这个时候它是一个不变的，所以我把它放在这么一个code里面，我们叫read，比如说就叫temple，还有就是读这个。温度和湿度的一个命令，我们就要命令。我们把这个值考进来，这个值我们要用16进制来表示，所以我们要给它加一个零X中间是用逗号来分割的那我们这边拷贝一下。
发言人  
因为这个值我们是不需要变的，所以我们只需要去按照这个来写就可以了，对吧？当然了，如果说你是有多个这种485的器件的话，你可以根据需要去做相应的一个设置和调整。那我们这边只是为了举这么一个例子。那这个时候，我们这个数据就已经做好了，吧？那我就可以去发送这个命令？去发送。
发言人  
那发送的话怎么发送呢？我们在串口当中提供了一个函数叫做38F？我们可以借助这个函数来完成这个发送。这个函数的话给了一个接口，对吧？这个函数接口的话我们需要用到两个，一个是buffer，一个是它的长度。
发言人  
那我们把这个buffer给它拿过来对吧？那就是说这个。它的长度可以去说一下，对吧？因为这个肯定是固定的。你只要确定了这个一定是固定的，12345678，那就是八个字节。那我们需要发送八个字节的数据，这个时候就把这个命令发过去。
发言人  
你这个命令一旦发过去之后，你的485的这个mode board协议的这个温湿度传感器，它应该给你应答，对吧？我们讲是主机询问统计应答，你发过去之后，他肯定要给你个应答，我们就要等待接收，对吧？这个时候，我们这个地方可以先把这个值给它清零一下。给它清零，你要等待接收，对吧？等待接收的话，那我们什么时候是接收到一包数据的呢？
发言人  
那我们接收数据的时候我们是知道的，当我们接收完一包数据的时候，我们这个标志位肯定是什么呢？肯定是一对吧。所以我们在主程序当中可以去判断这个标志位在其他时候你可以干你的显示，可以干你其他的事情，对吧？那我们这边当你接收完一个数据包的时候，它肯定是要的。那你看你去发送，你发送完你就不用管，对吧？等待他应答给你数据的时候，那我们这个标志位肯定为1。那它为叫我们首先把它清0，便于接收下一包数据。它为它一旦接收完成了，对吧？
发言人  
那我们怎么样判断我到底有没有接收到呢？那我把它再返回来，我们通过串口助手来看，所以我把我们接收的数据再返回过来，那接收的数据存在什么位置呢？我们前面也介绍过了，它应该是存放在我们这个buff里面，就你的接收缓冲区里面。
发言人  
那接收了多少个字节呢？我们在接收的时候，实际上这个地方有一个in desk，也就是这个索引，就接收这么多个字节，那我们就接收到这么多，对吧？那就接收这么多字节，接了这么多字节，我把它你发送过来了，对吧？你通过串口发送给这个传感器，传感器会给你回一个数据，回一个数据之后，我会接收到，接收到之后，会存在这个offer里面。我再通过这个把它发过来，我来看看到底我这边能不能完成这个。那我这个测试怎么测呢？
发言人  
那我们先来试一下，我们先把它编译下载一下，我们借助于串口，就说我模拟一下我这个地方，用这个用计算机这个地方作为我的温湿度传感器。你不是发给我一个指令，我就借助它给你返回一个指令，来看看对不对，对吧？那我把这个指令都先拷贝，提前拷贝过来，那我回的就是这个数据，这个就是传感器应该回的对吧？
发言人  
我们模拟这个传感器的通信过程，来保证我的代码先没有问题，然后我再去挂传感器。那这个时候，我们先来看看它能不能正常接收，或者说它能不能先发送过来？如果说我们的单片机发送了一个指令过来，那我们在这个窗口当中应该是可以看得到的对吧？这是我们的接收窗口。当我看到这个数据之后，我模拟的给他回一个数据，那我就用这个地方给它发送模拟传感器给他回过去。给他回过去之后，我们在程序当中是不是写了把你回给他的数据又给你发回来了。那我们应该在这个窗口当中还能够看到这一波数据。这样的话就保证了我们的这个串口通信的一个协议的一个过程没有问题，对吧？
发言人  
那到底能不能完成呢？我们首先打开串口，这个是com 14，然后的话我们从复位一下，我先把它复位一下。复议之后，它是文本模式，应该是打印的第一个提示信息。我把它切换成heck的模式，那这个时候你看它就发送给我们这个命令了，对吧？每大概2秒钟2秒钟发送一次，2秒钟发送一次对吧？他发送了就相当于他是发送给传感器的，他发送给传感器，我们传感器是不是要回他对吧？那我抓紧时间回他一个数据，那你看是不是回过来了，那我们把它暂停一下，那这个时候是刚才他发的这个，下面这个就是我们回的，我们回的应该是到哪呢？到648I对吧？
发言人  
那这个就相当于是我用这个串口助手模拟了我这个传感器的一个通信过程，对吧？就是说你单片机作为主机发送了一个寻址命令帧过来。你发送一个寻址命令帧过来，那我这个传感器是买的别人的，他的一个协议是规定好了。我接收到这个命令帧之后，我应该给你回一个数据。这个回收数据大概是什么样子呢？我们刚才用这个工具已经测试过了，对吧？你看你发我回，那我就模拟当前的温湿度，就按这个值来给你回。那我就给你回了一个数据，我给你回了一个数据之后，你在主程序当中，实际上是不是已经接收到了，对吧？
发言人  
因为你接收了之后又返回过来了，那我通过这个就清楚的明白了，我现在的这个测试已经通过了。那我接下来要做的工作应该就是什么？就是说我能够正常的发传感器回的，我也能够正常的接收到。那接下来我应该做的就是把这个数据做一个解析？把这个温度和湿度的值取出来，放到什么？放到我们这两个变量当中去？这样的话你接下来的显示也做好了，那你这个时候就可以正常显示了。所以我们这个程序这样子就写完了，对吧？
发言人  
那这个时候我们这个地方是不是要改了？我们这个地方实际上你不应该再发给传感器，对吧？你发给传感器干什么呢？传感器它是一个被动的器件，你发给他没有任何意义。我们这个地方发过来只是为了调试，对吧？只是为了调试，所以你发给这个指令给传感器，他接收到之后，他也不知道你让他干什么。因为它不理解你发的东西到底是什么含义，对吧？所以我们这个地方应该是把它注释掉，这个地方的目的只是为了保证我们能够调通。
发言人  
大家再理一下这个过程对吧？我们这个主机发送一个命令寻址针给传感器，传感器接收到之后对吧？接收到之后我们用这个软件模拟这个传感器的通信过程，给他回一个数据过来，回个数据过来之后，我们来看看我们能不能正常接收，就来测试串口能不能正常接收。那这个地方，你看正常接收了，为什么呢？因为我接收到之后，我是不是又把它返回过来了，我很清楚的通过这个地方看到你发给我的我又给你发过来了，我又看到了。但这个数据我们没必要发给传感器，对吧？
发言人  
因为我们接下来要做传感器了，所以这个地方我要做的工作应该是解析这一串数据。那怎么解析呢？我们可以把这个注释掉，我们可以写一个函数对吧？我们比如说写一个函数，我们来解析它。那我们可以写一个比如说model bus的一个handle，那我们怎么解析呢？我们可以给它传两个参数，我们把这个参数给它传进来，不就可以解析这个数据包里面的内容了吗？
发言人  
那接下来我们就来写这个函数，当然了也可以再单开一个点C文件。我们这边为了方便就直接把它写在这儿。待会儿的话，大家可以自己去把它封装到一个点C文件当中去。后面的话，如果说你还有更多的这个485的传感器挂在你这个总线上，那你可以都把它写到那一个文件当中去。我们这边只是为了给大家演示这个开发的过程，所以我们就直接写到主函数当中。大家自己写的时候，可以注意一下模块化。
发言人  
这个里面，我们肯定是要传的是两个参数，对吧？那我们定义两个参数，一个就是我们可以定义成指针类型的buff er另外一个就是你的数据有多少个，对吧？我们这个数据长度并不是特别多，对吧？我们就用这个来表示就可以了。因为我们传感器一旦买定了，我们事先是知道了它回流数据大概的有多少个字节，这个大家要根据需要去设置。
发言人  
那这个里面进来之后怎么办呢？我们要接收这个数据对吧？也就是说我要接收你回过来这个数据。我接收这个数据之后，我要首先判断你是不是发给我的，对吧？因为你可能是就是说我主机发过去之后，我回过来我要看看你这个地址码是哪个传感器给我的，我去干什么事情，对吧？因为我可能485上有可能会挂多个传感器，比如说挂多个点的这种温湿度，那我要知道当前是哪个点的温湿度的一个数据。所以我首先要判断的就是这个地址到底是不是给我的，是给我的我要看看功能码对吧？
发言人  
我再取数据。因为你这个时候我们只是做这么一个读的一个操作，对吧？这个大家感兴趣的可以去了解一下。
发言人  
我们接下来就来写这个代码，那怎么写呢？首先的话我要保证数据的通信的正确，我们先要做校验。所以既然要做校验，我们先定义两个变量，我们定一个一个CRC的一个变量，我们再为了做CRC的校验，我们再定义两个，一个叫CRC的H一个是高位，一个是低位。就是我们接收到这一波数据之后，我们除了把它接收过来，我还要判断你发的对不对，对吧？
发言人  
那怎么保证对不对呢？我们知道mode board当中有CRC校验，有这两个位是校验位。那我要把这两个读出来，和我把这个前面的数据自己做一个CRC的校验算法，把它算出来和这两个进行比较，看看是不是一致的。如果是一致的，我就代表这一个数据包没有问题，对吧？否则的话就代表出错，出错的话我可能要它干什么呢？我可以做一个重发机制重新获取一次，对吧？我们这边就是为了讲解，就不写那么复杂了，大家要知道这个大概的一个过程。
发言人  
接下来我就要来看，因为我这个总线上我们当前是只画了一个485的1个节点，那你有可能会挂多个，所以我要区分到底是哪一个给我的。如果说不是的话，我要不需要这个数据。所以我们这个地方可以先做一个判断，判一个什么判断呢？就是你接收这个buffer里面。这个办法里面我们知道它的第零个字节，也就是第零个数据，它就是我们的这个设备地址。那这个设备地址的话，如果说它不等于我们的这个03，对吧？因为我们现在是03，它不等于的话，那就不是我需要的数据，我就不用管它，对吧？所以我们这个地方可以在前面再定义一个地址，我把这个地址定义在这个里面，我们可以定义一个地址。
发言人  
当然了，大家的话也可以再单独开一个文件，对吧？比如说我们这个地址的话就叫温湿度的一个。温度和湿度，它的一个地址一个设备地址对吧？那这个设备地址的话是零X我们刚才讲的是0203。
发言人  
如果说你还有更多的传感器，那你可以再接着去定义，对吧？你可以接着去定义，你在这里面也可以去做判断对吧？接着去判断到底能够是哪一个的，可以去区分对吧？如果说它不等于这个，我们把这个拷贝过来。
发言人  
写这个的目的主要是为了区分多个节点。如果说你只有一个节点，那当然的话你要去判断到底是不是这个节点的就可以了。如果说不是的话，那我们就retain。那elf如果说是的话。然后我们再做处理，对吧？
发言人  
如果说是的话，我们怎么办呢？我们肯定要先做校验。如果说是，那我们要先做校验，校验正确才能去做处理，对吧？校验正确才能处理。
发言人  
那如果说他等的话，是你地址发给你的数据，那我们首先获取CRC，那CRC怎么办呢？我们可以用这个函数对吧？我们这边提供了一个函数，那就是CRC16。传递两个参数，我们很简单，直接用这个函数接口就行了。具体的代码的实现，大家如果说不是研究算法的可以不用关心它。那我们传递的是什么呢？那传递的就是我们的这个buffer，对吧？不是传递了一个参数，buffer那这个类就是把这两个参数传递过来。
发言人  
但是你需要注意的就是说我们计算CRC的时候是计算的什么呢？是计算这一包数据当中的前这么多位。这两个是本身就是CRC对吧？那我们不能计算它，我要计算它的前面这几个位置，那应该用你这个值干什么呢？应该减去2对吧？计算前面这一部分的CRC，然后计算完成之后，和你这个地方接收到了这个CRC进行比较对吧？这个大家一定要理解这个过程，那我们这个时候就计算出来的，计算出来之后，我要把它做一个分离，我要把它分成高位和低位，对吧？这样的话便于我们比较，当然你也可以直接去，取值去比较也可以。
发言人  
那我们为了大家更理解，那我们把这个值给大家取出来，那怎么取？我们就右移八位，因为这个CRC这个值我们定义的是一个整形的那我们取它的高八位就是这个高高半字节对吧？还有一个CRC的一个低位，第一位的话我们就用CRC取它的干什么呢？取它的第八位就可以了，对吧？与上一个0XFF取它的第八位，那这个时候就是CRC的L那接下来的话，我们就要把这个里面的这个高位和这个低位，和我们这个地方接收到的这个地方的高位和低位进行比较，对吧？
发言人  
那个是我们接收数据当中的这个地方，是CRC的高位，这个是CRC的低位，所以我们要进行比较，怎么比较呢？可以这样子来做判断，如果如果这个buffer里面的我要取出来的，就是你接收的和我们自己计算的做一个比较。接收的这个高位在什么位置呢？是它减去2，如果说他干什么呢？要不等于我们的CRC的一个高位，对吧？要货上你不光高位要等，低位也要等，对吧？
发言人  
我们这个地方把它拷贝一下。或者它什么？它的低位。就是高位要等于这个CRC的高位，就是你自己计算出来这个CRC的高位要等于你接收到了这个CRC的高位，你自己计算出来这个CRC的低位要等于什么呢？你自己计算出来的，就你要等于你自己接收到了这个CRC的一个低位，这样的话才能够是正确的一个数据包。
发言人  
如果说不等，那你就要我们就要退出，对吧？你说句不对吗？那我肯定是不能处理的。这个地方，你也可以再给它加个括号。这两个是并列的一个关系，就是是货的一个关系，就是它要成立，它也要成立。如果说任何一个不成立，就说明你的CRC计算错误，要退出。如果说这个也是正确的，CRC正确了，我们才能够去取我们的温度数据。
发言人  
那温度数据怎么取呢？温度数据我们很明显，按照我们这个数据包的格式，它是规定好的格式。我们肯定知道这个数据的一个温度在这个位置，对应的就在我们这个数据包的012第3和第四个，这个下标的一个数组里面的位置对吧？第三和第四这是01234对吧？第三和第四我们把这个值取出来，这个就是我们这个buffer里面的。第三个，我们要把它转成一个整型数，所以我们就把这个里面的第三个这个数，把它转成一个整形的，转成一个整形的，也就是强制类型转换一下。
发言人  
强制类型转换之后，我们把它再左移八位。因为这个F3这个是一个字节，对吧？我们把它先转成一个，它是一个字符型的，我把它转成整型的，把它左移八位，我们再干什么呢？再把它去加上我们的这个第四位。第八位，就是第一位自己，这样的话就组成了一个整型数？那你可以看到我们这个数据的时候构成的时候，这个温度和温度，温度这个是高位，这个是低位？那你把高位取出来，把它转成一个整形，把它左移八位，然后再加上它就构成了一个整形，对吧？这个大家要会这种方法，你会了之后，我们这个湿度也是一样的，那我们把这个湿度的这个值拷贝过来。
发言人  
那这个是buffer是哪一个呢？你要去看一下对吧？那就是这是01234，这是五六。5和6对吧5和6这个就把它做好了？5和6大家可以看一下？那这个五和六如果说你也完成了，你也完成了，那我们可以去编译。看一下对吧？
发言人  
那这个函数没有声明，我们把这个函数做一个声明，我直接把它声明到这个点H文件当中。这个抄错了，对吧？是我们这个函数。
发言人  
接下来，我们把它编译下载进去看一下。我们用模拟仿真的办法来看一下能不能正常的显示我们给它的一个微收入数据对吧？那我们编译下载，这个时候等待下载完成，我们把这个数据回给他，看看他在我们的显示屏当中能不能正常的去显示，对吧？然后我们打开串口，把这个数据回过去，我们来看一下。
发言人  
那回过去之后到底有没有正常收到呢？我们这个地方把它给它做一个什么呢？我们把这个打开，我们看看它能不能正常收到。我们这个时间给它放长一点，这样的话方便他这边太快了，对吧？我们把这个时间，比如说放到这个八，我们先测试对吧？测试完了我们再把这个时间改过来。不然的话，他发的太快了，对吧？
发言人  
好，下载完成，我们打开串口。
发言人  
我们等着他发送指令，他发送完了之后，我们给他回过去。回过去之后，我们看到这个地方好像有点问题，对吧？这个地方有点问题，那这个地方应该是什么呢？我们是我们来检查一下，在我们主函数当中，我们这个地方就是说一旦这个处理完成之后，我们要把这个值给它清零，对吧？你把它清零，否则的话你接收的时候这个值的话就不是从零开始接收了。我们要注意一下，把这个给它清成0，然后的话我们再编一下。然后再次下载。
发言人  
然后我们打开窗口。
发言人  
我们给他回数据，那这个时候回的数据就对了，但是回的时候就对了，我们显示对不对呢？我们可以看一下这个显示。显示的话这个地方它显示的是5.0和5.0%，那这个值感觉不是特别对吧？那我们这边回的是这个05AB那这个05AB到底是多大的这个值呢？我们可以通过计算器来算一下，这个是5AB我们以16进制5AB这个值大概是14.51度。因为我们这个文件当中给出了要除以100对，要除以100，所以这个十进制数是啊1451。那它的实际的值应该是14点点51度，但是我们刚才显示屏上看到的是5.0，对吧？所以有点问题。
发言人  
那我们就要看一下我们这边解析的这个地方。那这边解析的话，我们看一下再来看一下。首先是地址不符，要退出。地址符合之后先做校验，校验正确然后才取值。取值之后，我们这个地方要给它加一个括号。
发言人  
我们再编译下来看一下，我们再来编译下载进来，我们还是要模拟仿真一下，对吧？这个就相当于传感器回给我的。待会儿的话，我们这个程序调完之后，我们把传感器直接挂上去，一般来说就应该不会有太大的问题，对吧？
发言人  
我们来看一下初始的这个值。应该是这个25对吧？这是我们的初值。当我们去回给他数据的时候，那这边直接可以看到变得14.51。然后湿度的话是43.001 43.01，这个应该和我们这个值正好是对应的。我们刚才算了5AB就是14.51，就是11 451，我们再除以100，所以我们在显示的时候，就显示的是14.51，对吧？14.51那这个值就显示对了。
发言人  
所以你看我们调试的时候，是分步骤调的对吧？是先把这个显示调好，显示的值就是我们要显示的这个温湿度的一个值。我们当然了这个值的格式，我们要参考我们的温湿度传感器来设置，我们把它扩大100倍，显示的时候我们再把它缩小100倍，去做这个显示函数。我们把串口调通。串口调的时候，我一开始并没有去挂这个传感器，而是什么呢？而是用我们这个串口助手给我们去仿真。当然了，实际上你也可以用我们这种助手，也可以我们用这个助手去仿真一下这个传感器。因为这个传感器的数据格式，它一开始的这个东西我们都是知道的。
发言人  
它的响应数据，我们可以根据当前的这个环境值，用我们这个工具，用计算机的上位机先把这个值读出来。我们再来用这种方法去给他回。就是说我们模拟这个传感器给单品机回数据的一种方式。回给他之后，我们先来保证我们的代码没有问题，对吧？那这个时候我们已经保证了我们的代码没有太大的问题。
发言人  
接下来我们就要真正的把传感器挂到我们的板子上了。但是在挂板子之前，我们需要注意一下，我们485通信毕竟不是串口的232，对吧？我们这边用的还都是在用串串口的232来做的一个调试。
发言人  
但是我们485，我们知道485是有一个方向控制的。我们在前期课程当中介绍这个485的时候，我们提到过我们用的电路。我们看一下485的1个电路，在这个电路当中，我们除了这两个引脚之外，还有一个方向控制引脚。这个方向控制引脚是需要我们用单独的单片机的R口来控制的。我们需要改写一下我们这个串口的一个程序。所以我们实际上485的通信就是我们URT的东西，但是要稍微去修改一下，怎么修改呢？
发言人  
我们在这边首先要增加一个定义，我们要s bit。第一个什么呢？第一个我们的这个485的1个方向控制，我们是RS485，比如说是DRR方向控制，它在哪个引脚呢？我们这个板子上，它是P3.7这个引脚。当然你可以根据你自己的板子去设置这个方向控制引脚。这个是485的1个方向控制引脚，我们可以注册一下，是485的1个。
发言人  
发送和接收状态控制银角。那我们前面也讲介绍过对吧？我们系统上电的时候，我们所有的485的这种，无论是主机还是从机，都应该是处于什么接收状态。所以我们上电的时候要让它处于接收状态，它等于零的时候就是处于接收状态。
发言人  
当我们主机想要去发送数据的时候，比如说我们在主机这个地方我要去发送数据。当我去发送数据的时候，我要把它切换成什么发送状态，然后再去发送。那我们在这个地方要把它切换成发送状态，这个程序我们就不需要动了，对吧？因为我们这个是调用的上层的函数，是需要去切换成发送状态。我把它切换成发送状态，发送完成之后，我们前面也讲过，一旦发送完成，你要等待重新应答。所以你要把它转成什么接收状态，那我们把下面所有的都给它改过来，这个也需要用到。
发言人  
当然了我们现在是没有发送字符串。那我们如果说需要发送字符串的话，那我们也把它改写一下。这样的话我们后面就不需要再去改写了，对吧？同样的，我们这边的这个也把它改写一下。
发言人  
当然了，这个函数我们一般是不需要的对吧？这个我们调试完成我们就不需要了，但是我们这边也可以把它改了，这个时候我们就把它改完了，那485这1块我们就改完了，对吧？485改完之后，我们待会儿的话就可以把485挂上来，然后来完成我们的整个的一个功能的一个测试。
发言人  
那接下来，我会把这个485的1个传感器，给它挂在我们这个板子上。那我现在把这个温湿度传感器已经挂在了这个板子上，也就是我们这个地方有个接口，我们把这个温湿度传感器直接挂在上面。然后的话我们复位一下，我们来看一下复位之后，刚开始的话它显示的是这个25，对吧？有同学说为什么一开始温湿度没有过来呢？是因为我们程序当中是过了一点时间才去采集的数据。后来你看我们过了一点时间之后，过段时间之后是不是采集到了一个数据。所以这个地方就变成了我们的15.54和53.7%，那就和我现在的房间的温湿度是差不多的一个环境。那这个时候就完成了我们的开发。
发言人  
所以你看我们一开始并没有挂传感器，只是借助于我们这个助手，就能够完成我们整个的一个调试的一个工作，对吧？这个工作调试完成之后，我们再挂上我的硬件的时候，那我们就基本上能够判我这个程序有没有问题了，对吧？那基本上一般来讲都不会有太大的问题。
发言人  
如果说你想一开始的时候就想让我们这个程序进来，就能够有这个数据。那你可以在什么呢？在初始化这个地方，在这个地方我们应该首先给他一条，就是在进到主程序之前，我们先发送一个数据给他。你一旦发送数据给他之后，那他进到程序里面，进到Y21之后，他首先应该会进到这个地方，对吧？那它就能够把你这个温湿度数据解析出来，你显示的时候就应该是你的最新的温湿度数据。
发言人  
这个就是我们给大家讲的这种办法，对吧？就是说单片机作为主机如何去读取这种485接口的mode bar的协议的这种设备这种层级。把他的数据读过来之后，我们如何去做解析。这个大家感兴趣的可以去参考着我们这个就完成你自己的功能。
发言人  
比如说你在一个总线当中挂了多个这种温湿度传感器，或者说其他的一些设备。比如说我们前面做的项目当中，除了这种之外，还有其他的一些控制器，包括一些外部的这种大的这种O大的这种LED点阵屏，它都是485接口的那我们就可以在这一个485接口的总线上挂多个这种统计设备。我给他发数据，给他要数据也好，或者我给他发数据也好，那基本上都是我们这种方式。大家可以参考着去完成你自己的。以后如果说你碰到这种开发的话，那需要注意的就是说你买的这个模块，它的这个标准协议。
发言人  
如果说是mode bus的那你就可以去给它把这个如果说你仅仅是想读他的数据，或者你想修改他的数据，那你可以按照这种方式来做。当然了，如果说你是修改的话，那你就不能用这种code了，对吧？你要去如果说你的数据是要变化的，我们这边是因为它的这个读的命令，一旦你的这个地址确定了之后，它这个命令是不变的。所以我们把它放到room当中更方便一点，然后节省RAM的一个空间。我们怎么去读它呢？那就是给他发命令，对吧？发了命令之后，等待接收完成之后，我们把这个给它解析一下。解析的过程需要注意的就是说我们要识别到底是哪个设备的。
发言人  
知道是哪个设备了之后，还要干什么呢？还要做校验，校验正确之后，然后要取数据，取完数据之后付给你前面做好的一个设计的一个接口。可以用这种变量也好，你也可以用一个数组也好，或者一个缓冲区也好，做一个接口给它。这样的话，我在调试程序的时候，实际上就是分别调的。
发言人  
我这个数据用来获取温湿度传感器，并不影响我前期开发。我的显示也好，或者说我的判断处理控制等等这些功能。比如说你要根据这个温湿度做判断处理。我们在没有读取微深度数据之前，我在主存当中也可以把我们那个代码给它开发完成，对吧？这个大家一定要调试程序的时候是要分开来调的，不要把它搞到一起。
发言人  
另外一个需要注意的就是在我们485这个地方，它和我们传统的URT的开发没有太大的区别。唯一需要注意的就是这个方向控制。我们上电的时候使它处于接触状态。当我作为主机的时候，我想要去发送数据，那我们要把它干什么呢？把它切换成发送状态，一旦发送完成，立马切换成接收状态。因为你当前作为主机，你发送完命令之后，你要等待重新的应答。所以你要立马转成切换切换成这个接收状态，否则的话你就会错过它的应答了，对吧？当你需要发送的时候，你再切换成发送，否则的话你就要处于应答状态，这个大家在用的时候要注意。
发言人  
另外一个就是我们接收中断要用到超时接收的一个办法。有同学说为什么你不用DMI加空闲中断？就是DMI加空闲中断的一种方式。不好意思，我们这款单片机不具备这个功能，对吧？那只有高性能的单片机，比如说你用的一些STM32的单片机，它具备DMI加这个共享中断的处理方式，我们才能够用。
发言人  
那我们这种普通的51单片机，大家可以参考我们这种用定时接收器加上我们这种什么串口中断的方式，实现这种超时接收的办法来处理这个数据。就是说接收是接收，处理是处理，显示是显示，串口调试是串口调试。做完之后再来接你的硬件485来调试。我觉得这种的话可能会更方便一点。否则的话你把485接上来之后，如果说你不再单开一个串口去把你发送和接收数据都引到我们的上位机来观察。那你也不知道他的数据到底给没给你到底正确不正确。
发言人  
那不妨大家在做串口这种开发的过程当中，都可以借助我们这种助手先模拟它的一个通信过程。把这个通信过程模拟完成之后，再去上设备或者上硬件。包括你在开发一些通信的，比如说你要做一些无线的，比如说一些IT命令的这种无线模块的时候，我也是建议大家可以用这种方式，对吧？你不是发给我IT命令了吗？我就用这个东西给你回，我回我看看你能不能收到。
发言人  
你再发给我，我看看你没有收到，你有没有解析正确。然后的话我们再去具体的整个的一个联调，大家要熟悉这种开发的一个过程。当然了这个是我的一个个人经验。当然不同的人他开发的方式可能也不一样。有的人大牛他可能一次性就能够完成，对吧？
发言人  
有些同学主要是初学的，因为我们这边讲的代码大部分都是针对初次接触单片机或者初学的入门的。所以我们的代码并没有写的特别的好。实际上我们最终的话，后面还会讲这种代码的一个提升。
发言人  
代码的提升的话，我们要封装的对吧？我们现在的话还没有用到结构体，实际上我们可以用结构体把我们的代码在高度的模块化的封装。这样的话可能你的代码的这个规范性可能更高一点。那我们的代码的话后面还会去继续的做优化。我们这边只是为了让初学的同学便于掌握这个基础。你这个掌握之后，以后你再多看别人写的代码，那你慢慢的你的这个水平就可以得到一定的一个提升。
