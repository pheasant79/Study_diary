# 实战演练一：上位机操作

本章将通过实际操作演示如何使用上位机软件操作基于RS485的Modbus协议设备，以温湿度传感器为例，展示数据读取和参数设置过程。

## 工具准备

<details>
<summary>实验所需的硬件与软件</summary>

### 硬件准备
- 温湿度传感器（支持RS485 Modbus协议）
- USB转RS485转换器
- 连接线缆

### 软件准备
- Modbus Poll（作为主机模拟工具）
- Modbus Slave（作为从机模拟工具）
- 虚拟串口软件（用于测试时模拟设备）
</details>

## USB转RS485转换器连接

首先，我们需要将温湿度传感器通过USB转RS485转换器连接到电脑。

<div style="background-color: #e9f7fe; padding: 15px; margin: 15px 0; border-left: 4px solid #4cb3d4; border-radius: 3px;">
<strong>连接说明：</strong><br>
1. USB转RS485模块的A线 → 温湿度传感器的A线<br>
2. USB转RS485模块的B线 → 温湿度传感器的B线<br>
3. 提供合适的电源给温湿度传感器<br>
4. 将USB转RS485模块插入电脑USB接口
</div>

> **提示**：插入USB设备后，需要查看设备管理器确认COM口号，以便后续设置。

## 温湿度传感器参数说明

在开始通信前，需要了解传感器的通信参数和寄存器映射。以下是典型RS485温湿度传感器的基本参数：

| 参数项 | 默认值 | 说明 |
|-------|-------|------|
| 设备地址 | 1 | 可修改（范围1-247） |
| 波特率 | 9600 | 可修改（支持2400/4800/9600/19200等） |
| 数据位 | 8 | 固定值 |
| 停止位 | 1 | 固定值 |
| 校验方式 | 无 | 可修改（无/奇校验/偶校验） |
| 通信协议 | Modbus-RTU | 固定值 |

### 寄存器地址映射表

温湿度传感器的寄存器地址映射如下：

<details>
<summary>展开完整寄存器映射表</summary>

| 寄存器地址 | 组态地址 | 含义 | 数据类型 | 操作权限 | 取值范围 |
|-----------|---------|------|---------|---------|---------|
| 0x0000 | 40001 | 温度 | 16位整型 | 只读 | 0-65535 |
| 0x0001 | 40002 | 湿度 | 16位整型 | 只读 | 0-65535 |
| 0x0066 | 40103 | 设备地址 | 16位整型 | 读/写 | 1-247 |
| 0x0067 | 40104 | 波特率 | 16位整型 | 读/写 | 0-5 |
| 0x0068 | 40105 | 校验方式 | 16位整型 | 读/写 | 0-2 |

**波特率对应关系**：
- 0: 2400bps
- 1: 4800bps
- 2: 9600bps（默认）
- 3: 19200bps
- 4: 38400bps
- 5: 57600bps

**校验方式对应关系**：
- 0: 无校验（默认）
- 1: 奇校验
- 2: 偶校验

</details>

## Modbus Poll软件操作

Modbus Poll是一款功能强大的Modbus主机模拟工具，可用于读取从机数据和写入从机参数。

### 软件连接设置

1. 打开Modbus Poll软件
2. 点击菜单"Connection" → "Connect..."
3. 设置连接参数：
   - Connection中选择相应的COM口
   - 波特率设为9600
   - 数据位8，停止位1，无校验
   - 协议选择RTU

<div style="text-align: center; margin: 15px 0;">
[此处需插入连接设置界面截图]
</div>

### 读取温湿度数据

1. 点击菜单"Setup" → "Read/Write Definition..."
2. 设置读取参数：
   - Slave ID: 1（设备地址）
   - Function: 03 (Read Holding Registers)
   - Address: 0（起始寄存器地址）
   - Length: 2（读取2个寄存器，分别为温度和湿度）
   - 点击"OK"确认

<div style="margin: 15px 0; padding: 10px; border: 1px dashed #ddd; border-radius: 5px;">
<strong>数据解析说明：</strong><br>
温湿度传感器返回的数据通常需要经过转换才能获得实际的温湿度值：<br>
- 温度值 = 返回值 ÷ 100（例如：返回值2563表示25.63°C）<br>
- 湿度值 = 返回值 ÷ 100（例如：返回值5472表示54.72%RH）
</div>

### 修改设备地址

要修改设备地址，需要使用功能码06（写单个寄存器）：

1. 点击菜单"Setup" → "Read/Write Definition..."
2. 设置写入参数：
   - Slave ID: 1（当前设备地址）
   - Function: 06 (Write Single Register)
   - Address: 102（设备地址寄存器，十进制表示，对应十六进制的0x0066）
   - 在数据表格对应位置输入新地址值（例如：3）
   - 按Enter键确认修改

```
发送帧: 01 06 00 66 00 03 A8 14
响应帧: 01 06 00 66 00 03 A8 14
```

<div style="background-color: #ffe8e8; padding: 10px; margin: 15px 0; border-left: 4px solid #ff9999; border-radius: 3px;">
<strong>注意：</strong> 修改设备地址后，后续通信必须使用新地址，否则设备将不再响应原地址的命令！
</div>

### 修改波特率

修改波特率的步骤与修改设备地址类似：

1. 设置Slave ID为当前设备地址
2. 功能码选择06
3. 地址设为103（波特率寄存器，十进制表示，对应十六进制的0x0067）
4. 输入波特率对应的代码值（例如：3表示19200bps）

```
发送帧: 03 06 00 67 00 03 39 D9
响应帧: 03 06 00 67 00 03 39 D9
```

<div style="background-color: #fff9e6; padding: 10px; margin: 15px 0; border-left: 4px solid #ffcc66; border-radius: 3px;">
<strong>警告：</strong> 修改波特率后，需要在上位机软件中相应调整连接波特率，才能继续通信！
</div>

## 使用Modbus Slave模拟从机

在没有实际设备或需要进行协议测试时，可以使用Modbus Slave软件模拟从机设备。

### 创建模拟从机

1. 打开Modbus Slave软件
2. 点击菜单"Connection" → "Connect..."
3. 设置与Modbus Poll相同的通信参数
4. 点击菜单"Setup" → "Slave Definition..."
5. 设置从机参数：
   - Slave ID: 1
   - 创建寄存器表：添加起始地址为0，长度为10的寄存器区域

### 模拟温湿度数据

1. 在寄存器表中，找到地址0和地址1（对应温度和湿度）
2. 输入模拟值：
   - 地址0：输入1163（表示11.63°C）
   - 地址1：输入5523（表示55.23%RH）

<div style="text-align: center; margin: 15px 0;">
[此处需插入Modbus Slave操作界面截图]
</div>

### 使用虚拟串口进行测试

要实现Modbus Poll与Modbus Slave的通信测试，需要创建虚拟串口对：

1. 安装虚拟串口软件（如VSPD、com0com等）
2. 创建一对虚拟COM口（例如：COM2和COM3）
3. 在Modbus Poll中连接COM2
4. 在Modbus Slave中连接COM3
5. 此时可以使用Modbus Poll读写Modbus Slave中的数据

## 通信过程分析

### 读取温湿度数据的通信示例

<details>
<summary>完整的通信数据帧分析</summary>

读取温湿度的通信过程：

**主机请求（读取寄存器0和1）**：
```
01 03 00 00 00 02 C4 0B
```
- 01: 从机地址
- 03: 功能码（读保持寄存器）
- 00 00: 起始寄存器地址（0）
- 00 02: 读取寄存器数量（2个）
- C4 0B: CRC校验

**从机响应**：
```
01 03 04 04 89 15 B2 70 77
```
- 01: 从机地址
- 03: 功能码
- 04: 返回字节数（4字节）
- 04 89: 第一个寄存器值（温度1161 → 11.61°C）
- 15 B2: 第二个寄存器值（湿度5554 → 55.54%RH）
- 70 77: CRC校验

</details>

### 修改设备参数的通信示例

<details>
<summary>通过功能码06修改设备地址的过程分析</summary>

修改设备地址的通信过程：

**主机请求（修改设备地址为3）**：
```
01 06 00 66 00 03 A8 14
```
- 01: 当前从机地址
- 06: 功能码（写单个寄存器）
- 00 66: 寄存器地址（设备地址寄存器）
- 00 03: 写入值（新地址=3）
- A8 14: CRC校验

**从机响应**：
```
01 06 00 66 00 03 A8 14
```
- 同请求帧完全一致，表示写入成功

</details>

## 常见问题与解决方法

### 通信失败的常见原因

<table style="width:100%; border-collapse: collapse; margin: 15px 0;">
  <tr style="background-color: #f2f2f2;">
    <th>问题现象</th>
    <th>可能原因</th>
    <th>解决方法</th>
  </tr>
  <tr>
    <td>无响应</td>
    <td>
      - 设备地址错误<br>
      - 波特率不匹配<br>
      - 接线错误（A/B接反）<br>
      - 设备未上电
    </td>
    <td>
      - 检查设备地址设置<br>
      - 确认波特率设置<br>
      - 检查A/B线连接<br>
      - 确认设备电源
    </td>
  </tr>
  <tr>
    <td>CRC错误</td>
    <td>
      - 通信干扰<br>
      - 波特率不稳定
    </td>
    <td>
      - 检查连接线质量<br>
      - 使用屏蔽双绞线<br>
      - 尝试降低波特率
    </td>
  </tr>
  <tr>
    <td>数据异常</td>
    <td>
      - 数据格式理解错误<br>
      - 寄存器地址错误
    </td>
    <td>
      - 确认数据转换方法<br>
      - 查阅设备手册确认地址映射
    </td>
  </tr>
</table>

### 调试技巧

1. **逐步调试**：
   - 先确认基本通信（如读取数据）
   - 成功后再尝试修改参数

2. **参数备份**：
   - 修改设备参数前记录原始值
   - 防止修改错误导致设备无法通信

3. **使用模拟工具**：
   - 不确定命令是否正确时，先用Modbus Slave测试
   - 验证命令格式和参数设置

4. **观察通信数据**：
   - 使用串口调试助手查看原始数据帧
   - 分析CRC校验是否正确

---

**需要插入图片的位置**：
1. USB转RS485转换器连接图
2. Modbus Poll软件连接设置界面截图
3. Modbus Poll读取温湿度数据界面截图
4. Modbus Slave模拟从机界面截图
5. 虚拟串口软件设置界面截图

---

## 总结

- RS485设备可通过USB转换器连接到电脑进行操作
- Modbus Poll和Modbus Slave是实用的调试工具
- 掌握寄存器地址映射是操作设备的关键
- 修改设备参数时需谨慎，避免导致通信中断
- 虚拟串口工具可用于模拟测试Modbus通信 