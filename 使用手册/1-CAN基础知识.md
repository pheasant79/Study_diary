# CAN基础知识

<div align="center">

![CAN基础知识](https://via.placeholder.com/600x150/0078D7/FFFFFF?text=CAN%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86)

</div>

## 📑 目录

- [CAN基础知识](#can基础知识)
  - [📑 目录](#-目录)
  - [CAN总线基本概念](#can总线基本概念)
  - [CAN总线电平特性](#can总线电平特性)
  - [CAN总线帧格式](#can总线帧格式)
  - [CAN总线工作原理](#can总线工作原理)
    - [1. 消息传输和过滤](#1-消息传输和过滤)
    - [2. 总线仲裁机制](#2-总线仲裁机制)
    - [3. 错误处理机制](#3-错误处理机制)
    - [4. 总线物理层特性](#4-总线物理层特性)

---

## CAN总线基本概念

<details>
<summary>💡 什么是CAN总线？</summary>

CAN（Controller Area Network，控制器局域网）总线是一种串行通信协议，最初由德国BOSCH公司为汽车行业开发，用于车内电子控制单元（ECU）之间的通信。

**CAN的关键特点**：
- **多主机通信**：网络中的任何节点都可以发起通信
- **广播通信**：所有节点都能接收到总线上的所有数据
- **消息机制**：通信基于消息ID而非节点地址
- **高可靠性**：具备完善的错误检测和处理机制
- **高实时性**：最高波特率可达1Mbps
- **抗干扰性强**：采用差分信号传输方式

在STM32F103C8T6中，CAN外设是一个完整的CAN协议控制器，支持CAN2.0A和CAN2.0B协议。

</details>

## CAN总线电平特性

CAN总线采用差分信号传输，具有两种电平状态：

<div style="background-color:#f8f9fa;padding:15px;border-radius:5px;margin:10px 0;">

- **显性状态（Dominant，逻辑0）**：
  - CAN_H = 3.5V
  - CAN_L = 1.5V
  - 差分电压约2V

- **隐性状态（Recessive，逻辑1）**：
  - CAN_H ≈ CAN_L ≈ 2.5V
  - 差分电压约0V

</div>

CAN总线电平示意图：

```
     电压(V)
     ^
3.5V |    CAN_H (显性)
     |    *-----------*
     |    |           |
2.5V |----*           *----  CAN_H/CAN_L (隐性)
     |    |           |
     |    |           |
1.5V |    *-----------*      CAN_L (显性)
     |
     +----------------------> 时间
        隐性    显性    隐性
```

**重要特性**：显性状态会覆盖隐性状态。当多个节点同时发送时，只要有一个节点发送显性位，总线就处于显性状态。这是CAN总线仲裁机制的基础。

## CAN总线帧格式

CAN协议定义了四种帧类型：数据帧、远程帧、错误帧和过载帧。其中数据帧是最常用的。

<details>
<summary>📋 CAN标准帧和扩展帧结构详解</summary>

**标准帧格式**（11位ID）：
```
+-------+-------------+-------------+--------+-------+-------+-------+----------+
| 起始位 |   仲裁场    |    控制场   | 数据场 | CRC场 | ACK场 | 结束符 | 帧间间隔 |
|  SOF  | ID(11) + RTR| IDE+r0+DLC  | 0-8字节| 16位  | 2位   | 7位   |  3位    |
+-------+-------------+-------------+--------+-------+-------+-------+----------+
```

**扩展帧格式**（29位ID）：
```
+-------+-----------------------------+----------------+--------+-------+-------+-------+----------+
| 起始位 |            仲裁场           |     控制场     | 数据场 | CRC场 | ACK场 | 结束符 | 帧间间隔 |
|  SOF  | ID(11)+SRR+IDE+ID(18)+RTR  | r1+r0+DLC     | 0-8字节| 16位  | 2位   | 7位   |  3位    |
+-------+-----------------------------+----------------+--------+-------+-------+-------+----------+
```

**各字段说明**：
- **SOF (Start of Frame)**：单个显性位，表示帧的开始
- **ID**：报文标识符，决定报文优先级（越小优先级越高）
- **RTR (Remote Transmission Request)**：区分数据帧(0)和远程帧(1)
- **IDE (Identifier Extension)**：区分标准帧(0)和扩展帧(1)
- **DLC (Data Length Code)**：数据长度代码，表示数据场字节数(0-8)
- **数据场**：0-8字节的数据内容
- **CRC**：循环冗余校验，用于错误检测
- **ACK**：接收方确认位
- **结束符**：7个连续的隐性位
- **帧间间隔**：3个或更多隐性位，分隔连续帧

</details>

## CAN总线工作原理

CAN总线工作基于以下关键机制：

### 1. 消息传输和过滤

CAN网络采用广播式通信，一个节点发送的消息会被所有节点接收。每个接收节点通过**消息过滤器**决定是否接受该消息：

<div style="background-color:#fff8e1;padding:15px;border-radius:5px;border-left:5px solid #ffa000;margin:10px 0;">

- 所有报文都包含唯一ID
- 接收节点通过配置过滤器来筛选感兴趣的ID
- 过滤器可以设置为接收单个ID或一组ID
- STM32F103C8T6提供14个过滤器组，可精确控制哪些消息被接收

</div>

### 2. 总线仲裁机制

当多个节点同时发送数据时，CAN总线通过**非破坏性仲裁**机制解决冲突：

```
节点A (ID:15)  1 0 0 0 1 1 1 1... ←停止发送，变为接收者
节点B (ID:10)  1 0 1 0 1 0 1 0... ←继续发送，获得总线访问权
总线实际状态   1 0 0 0 1 0 1 0...
                     ↑
                 仲裁点(显性胜出)
```

- 发送节点逐位比较ID
- 当节点发送隐性位(1)，但检测到显性位(0)时，自动退出仲裁
- ID值较低的节点获得发送权限
- 整个过程自动执行，无需重发，提高了总线效率

### 3. 错误处理机制

CAN协议定义了5种错误检测机制：

<details>
<summary>🔍 CAN错误检测与处理机制详解</summary>

**1. 位错误**：
- 发送方发送位后监听总线
- 如检测到的电平与发送的不同（仲裁阶段除外），则产生位错误

**2. 填充错误**：
- CAN使用位填充规则：连续5个相同位后必须插入1个反向位
- 违反此规则会产生填充错误

**3. CRC错误**：
- 接收方计算CRC并与发送方提供的值比较
- 不匹配时产生CRC错误

**4. 帧格式错误**：
- 固定格式字段（如界定符）包含非法值

**5. 确认错误**：
- 发送方在ACK槽未检测到显性位

**错误处理流程**：
1. 检测到错误的节点发送错误帧
2. 其他节点也检测到错误，发送错误帧
3. 原始消息被丢弃，发送方自动重发

**错误状态**：
每个节点维护两个错误计数器：
- 发送错误计数器(TEC)
- 接收错误计数器(REC)

基于计数器值，节点可处于三种状态：
- **错误活动**：0-127，正常参与总线
- **错误被动**：128-255，仍可通信但有限制
- **总线关闭**：>255，节点自我隔离

</details>

### 4. 总线物理层特性

标准CAN通信要求：

- **总线拓扑**：线型总线（不推荐星型或环型）
- **终端电阻**：总线两端各120Ω
- **通信速率**：取决于总线长度
  - 1Mbps：最大40米
  - 500kbps：最大100米
  - 125kbps：最大500米
- **最大节点数**：理论上110个，实际通常不超过64个

---

<div style="background-color:#e8f4ff;padding:15px;border-radius:5px;margin:10px 0;">

**STM32F103C8T6中的CAN特性**：
- 支持CAN2.0A和CAN2.0B协议
- 最高波特率1Mbps
- 3个发送邮箱
- 2个接收FIFO，每个可存储3条消息
- 14个过滤器组
- 可配置中断源：发送完成、接收、错误等
- 支持自动重传、睡眠模式、唤醒功能等

</div>

了解了CAN的基础知识后，接下来我们将学习如何在STM32F103C8T6上实现CAN通信。 